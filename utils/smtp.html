<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>SMTP 발송 테스트 (Serverless)</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 2em; }
        .container { max-width: 800px; margin: auto; }
        label { display: inline-block; width: 120px; margin-top: .5em; }
        input, select { width: 250px; padding: .4em; box-sizing: border-box; }
        button { margin: 1em .2em; padding: .5em 1em; }
        #result { margin-top: 1em; font-weight: bold; padding: .5em; border-radius: 4px; }
        .hidden { display: none; }
        .back-link { margin-bottom: 2em; display: block; }
        #logDisplaySection { margin-top: 1.5em; }
        #logOutput {
            background: #f4f4f4;
            border: 1px solid #ddd;
            padding: 10px;
            max-height: 400px;
            overflow-y: auto;
            white-space: pre-wrap;
            font-family: monospace;
            font-size: 0.9em;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <div class="container">
        <a href="/" class="back-link">&larr; 허브 페이지로 돌아가기</a>
        <h2>SMTP 발송 테스트</h2>
        <form id="smtpForm">
            <label>SMTP Host:</label>
            <input name="host" placeholder="예: smtp.gmail.com"><br>
            <label>Port:</label>
            <input name="port" placeholder="예: 587"><br>
            <label>Use Auth:</label>
            <select name="authRequired" id="authRequired">
                <option value="false">No</option>
                <option value="true" selected>Yes</option>
            </select><br>
            <div id="authFields">
                <label>User:</label>
                <input name="user" placeholder="이메일 주소"><br>
                <label>Password:</label>
                <input type="password" name="pass" placeholder="비밀번호 또는 앱 비밀번호"><br>
            </div>
            <label>From:</label>
            <input name="from" placeholder="보내는 사람 이메일"><br>
            <label>To:</label>
            <input name="to" placeholder="받는 사람 이메일"><br>
            <label>Security:</label>
            <select name="security">
                <option value="none">None</option>
                <option value="tls" selected>STARTTLS</option>
                <option value="ssl">SSL/TLS</option>
            </select><br>
            <button type="submit">메일 발송 테스트</button>
            <button type="reset">초기화</button>
        </form>
        
        <div>
            <h4>⚠️ 25번 포트 사용 안내</h4>
            <p>Vercel의 정책상 25번 포트는 차단되어 있으므로 이 페이지에서 테스트할 수 없습니다. 25번 포트 테스트가 필요한 경우, 내부망에서 <a href="http://192.168.130.114:8080">로컬 서버 테스트 페이지</a>를 이용해 주세요.</p>
        </div>

        <div id="result"></div>

        <div id="logDisplaySection" class="hidden">
            <h4>SMTP 통신 로그</h4>
            <pre id="logOutput"></pre>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const authRequiredSelect = document.getElementById('authRequired');
            const authFields = document.getElementById('authFields');
            const form = document.getElementById('smtpForm');
            const resultEl = document.getElementById('result');
            const logSectionEl = document.getElementById('logDisplaySection');
            const logOutputEl = document.getElementById('logOutput');

            function toggleAuthFields() {
                authFields.classList.toggle('hidden', authRequiredSelect.value === 'false');
            }
            authRequiredSelect.addEventListener('change', toggleAuthFields);
            toggleAuthFields();

            form.addEventListener('submit', async e => {
                e.preventDefault();
                const btn = form.querySelector('button[type="submit"]');

                // UI 초기화
                btn.disabled = true;
                btn.textContent = '전송 중…';
                resultEl.innerHTML = '';
                logOutputEl.textContent = '';
                logSectionEl.classList.add('hidden');

                try {
                    const resp = await fetch('/api/send', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                        body: new URLSearchParams(new FormData(form))
                    });
                    
                    const data = await resp.json(); // 응답을 JSON으로 파싱

                    resultEl.innerHTML = data.message; // 결과 메시지 표시

                    // 로그 데이터가 있으면 화면에 표시
                    if (data.logs && data.logs.length > 0) {
                        logOutputEl.textContent = data.logs.join('\n');
                        logSectionEl.classList.remove('hidden');
                    }
                    
                } catch (err) {
                    resultEl.innerHTML = `<span style='color:red;'>⚠️ 클라이언트 오류: ${err.message}</span>`;
                } finally {
                    btn.disabled = false;
                    btn.textContent = '메일 발송 테스트';
                }
            });
        });
    </script>
</body>
</html>