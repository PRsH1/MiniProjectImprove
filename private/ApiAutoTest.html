<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>API ìë™í™” í…ŒìŠ¤íŠ¸ í˜ì´ì§€</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <style>
        body { padding: 20px; background-color: #f8f9fa; }
        .container { max-width: 1200px; background: white; padding: 30px; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .status-pass { color: green; font-weight: bold; }
        .status-fail { color: red; font-weight: bold; }
        .status-skip { color: #f0ad4e; font-weight: bold; }
        .log-box { font-size: 0.85em; max-height: 200px; overflow-y: auto; background: #eee; padding: 10px; display: none; margin-top: 5px; border-radius: 5px; white-space: pre-wrap; }
        .special-config { background-color: #e3f2fd; border: 1px solid #90caf9; padding: 20px; border-radius: 5px; margin-bottom: 20px; }
        .field-row { background: #fff; padding: 8px; border-radius: 4px; border: 1px solid #dee2e6; margin-bottom: 5px; }
        .separator { border-top: 1px dashed #90caf9; margin: 20px 0; }
        .section-title { font-weight: bold; color: #495057; margin-bottom: 10px; }
        
        .opa-badge { 
            display: flex; 
            align-items: center;
            padding: 8px 12px; 
            margin-bottom: 5px; 
            background: #fff; 
            border: 1px solid #dee2e6; 
            border-radius: 6px; 
            font-size: 0.9em; 
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        }
        .opa-code { font-weight: bold; color: #333; margin-right: 5px; display: block;}
        .opa-name { color: #666; font-size: 0.9em; }
        .method-badge { width: 60px; text-align: center; margin-right: 10px; flex-shrink: 0; }
    </style>
</head>
<body>

<div class="container">
    <h2 class="mb-4">ğŸš€ API ì‹œë‚˜ë¦¬ì˜¤ í…ŒìŠ¤íŠ¸ (Total V21)</h2>

    <div class="accordion mb-4" id="accordionApiList">
        <div class="accordion-item">
            <h2 class="accordion-header">
                <button class="accordion-button collapsed fw-bold bg-light" type="button" data-bs-toggle="collapse" data-bs-target="#collapseList">
                    ğŸ“‹ í…ŒìŠ¤íŠ¸ ê°€ëŠ¥í•œ API ëª©ë¡ ë° ë©”ì†Œë“œ í™•ì¸ (í´ë¦­í•˜ì—¬ í¼ì¹˜ê¸°)
                </button>
            </h2>
            <div id="collapseList" class="accordion-collapse collapse" data-bs-parent="#accordionApiList">
                <div class="accordion-body bg-light">
                    <div class="row g-2" id="apiListContainer"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="card mb-3">
        <div class="card-header bg-dark text-white">1. ê³µí†µ ì„¤ì • (ê¸°ë³¸ ì¸ì¦)</div>
        <div class="card-body">
            <div class="row g-3">
                <div class="col-md-6">
                    <label class="form-label">Base URL</label>
                    <input type="text" id="baseUrl" class="form-control" value="https://api.eformsign.com" placeholder="https://...">
                </div>
                <div class="col-md-6">
                    <label class="form-label">Access Token (Bearer)</label>
                    <input type="text" id="accessToken" class="form-control" placeholder="ì¼ë°˜ APIìš© í† í°">
                </div>
            </div>
        </div>
    </div>

    <div class="special-config">
        <h5 class="fw-bold text-primary mb-3">âš¡ ì‹œë‚˜ë¦¬ì˜¤ë³„ í•„ìˆ˜ ë°ì´í„° ì„¤ì •</h5>
        
        <div class="p-3 bg-white rounded mb-3 border">
            <div class="section-title text-success">ê³µí†µ ì…ë ¥ ë°ì´í„° (Doc 1 & ì‘ì„± API ê³µìš©)</div>
            <div class="row g-2 mb-2">
                <div class="col-md-4">
                    <input type="text" id="targetEmail" class="form-control form-control-sm" placeholder="ìˆ˜ì‹ ì Email">
                </div>
                <div class="col-md-4">
                    <input type="text" id="targetName" class="form-control form-control-sm" placeholder="ìˆ˜ì‹ ì ì´ë¦„">
                </div>
                <div class="col-md-4">
                    <input type="text" id="targetPhone" class="form-control form-control-sm" placeholder="ìˆ˜ì‹ ì ì—°ë½ì²˜">
                </div>
            </div>
            
            <div class="d-flex justify-content-between align-items-center mb-1">
                <span class="small text-muted fw-bold">ì…ë ¥ í•„ë“œ (Fields - Doc 1 / ê³µìš©)</span>
                <button class="btn btn-sm btn-outline-success py-0" onclick="addFieldRow('fieldsContainer')">+ í•„ë“œ ì¶”ê°€</button>
            </div>
            <div id="fieldsContainer"></div>
        </div>

        <div class="section-title">A. ìƒˆ ë¬¸ì„œ ì‘ì„± (OPA 005 - ë‚´ë¶€ì)</div>
        <div class="row g-3 mb-2">
            <div class="col-md-4">
                <label class="form-label small fw-bold">Template ID (Doc 1)</label>
                <input type="text" id="targetTemplateId" class="form-control form-control-sm" placeholder="ë‚´ë¶€ìš© í…œí”Œë¦¿ ID">
            </div>
        </div>

        <div class="separator"></div>

        <div class="section-title text-primary">B. ìƒˆ ë¬¸ì„œ ì‘ì„± (OPA 007 - ì™¸ë¶€ì)</div>
        <div class="row g-3 mb-2">
            <div class="col-md-4">
                <label class="form-label small fw-bold">Company ID</label>
                <input type="text" id="companyId" class="form-control form-control-sm" placeholder="íšŒì‚¬ ID">
            </div>
            <div class="col-md-4">
                <label class="form-label small fw-bold">External Template ID</label>
                <input type="text" id="extTemplateId" class="form-control form-control-sm" placeholder="ì™¸ë¶€ìš© í…œí”Œë¦¿ ID">
            </div>
            <div class="col-md-4">
                <label class="form-label small fw-bold text-danger">Company API Key</label>
                <input type="text" id="companyApiKey" class="form-control form-control-sm border-danger" placeholder="API Key (Base64 ìë™ ë³€í™˜ë¨)">
            </div>
        </div>

        <div class="separator"></div>

        <div class="section-title">C. ë‹¤ìš´ë¡œë“œ í…ŒìŠ¤íŠ¸ìš© ID</div>
        <div class="row g-3">
            <div class="col-md-6">
                <label class="form-label small">ì™„ë£Œëœ ë¬¸ì„œ ID (OPA 004ìš©)</label>
                <input type="text" id="downloadDocId" class="form-control form-control-sm" placeholder="ì™„ë£Œ ë¬¸ì„œ ID">
            </div>
            <div class="col-md-6">
                <label class="form-label small">ì²¨ë¶€íŒŒì¼ í¬í•¨ ë¬¸ì„œ ID (OPA 006ìš©)</label>
                <input type="text" id="attachDocId" class="form-control form-control-sm" placeholder="ì²¨ë¶€íŒŒì¼ ë¬¸ì„œ ID">
            </div>
        </div>

        <div class="separator"></div>

        <div class="section-title text-warning">D. ë©¤ë²„ & ê·¸ë£¹ ê´€ë¦¬</div>
        <div class="row g-3 mb-2">
            <div class="col-md-6">
                <label class="form-label small fw-bold text-warning">í…ŒìŠ¤íŠ¸í•  ë©¤ë²„ ID</label>
                <input type="text" id="memberId" class="form-control form-control-sm border-warning" value="test123456@test1234.com">
            </div>
        </div>

        <div class="separator"></div>

        <div class="section-title text-info">E. ë©€í‹° í…œí”Œë¦¿ ì‘ì„± ì¶”ê°€ ì„¤ì • (OPA 021 - Doc 2)</div>
        <div class="p-3 bg-white rounded border border-info">
            <div class="row g-2 mb-2">
                <div class="col-md-3">
                    <label class="form-label small fw-bold">Template ID 2 *</label>
                    <input type="text" id="targetTemplateId2" class="form-control form-control-sm" placeholder="ë‘ ë²ˆì§¸ í…œí”Œë¦¿ ID">
                </div>
                <div class="col-md-3">
                    <label class="form-label small">ìˆ˜ì‹ ì Email 2</label>
                    <input type="text" id="targetEmail2" class="form-control form-control-sm" placeholder="Doc 2 ìˆ˜ì‹ ì Email">
                </div>
                <div class="col-md-3">
                    <label class="form-label small">ìˆ˜ì‹ ì ì´ë¦„ 2</label>
                    <input type="text" id="targetName2" class="form-control form-control-sm" placeholder="Doc 2 ìˆ˜ì‹ ì ì´ë¦„">
                </div>
                <div class="col-md-3">
                    <label class="form-label small">ìˆ˜ì‹ ì ì—°ë½ì²˜ 2</label>
                    <input type="text" id="targetPhone2" class="form-control form-control-sm" placeholder="Doc 2 ìˆ˜ì‹ ì ì—°ë½ì²˜">
                </div>
            </div>
            
            <div class="d-flex justify-content-between align-items-center mb-1 mt-2">
                <span class="small text-muted fw-bold text-info">ì…ë ¥ í•„ë“œ (Fields - Doc 2 ì „ìš©)</span>
                <button class="btn btn-sm btn-outline-info py-0" onclick="addFieldRow('fieldsContainer2')">+ Doc 2 í•„ë“œ ì¶”ê°€</button>
            </div>
            <div id="fieldsContainer2"></div>
        </div>
    </div>

    <button class="btn btn-primary w-100 mb-4 py-2 fw-bold" onclick="runAllTests()">ì „ì²´ í…ŒìŠ¤íŠ¸ ì‹œë‚˜ë¦¬ì˜¤ ì‹œì‘ â–¶</button>

    <h5 id="progressText">ëŒ€ê¸° ì¤‘...</h5>
    <div class="progress mb-3">
        <div id="progressBar" class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%"></div>
    </div>

    <table class="table table-hover table-bordered align-middle">
        <thead class="table-light text-center">
            <tr>
                <th width="5%">No.</th>
                <th width="40%">API ì´ë¦„ / Endpoint</th>
                <th width="10%">Method</th>
                <th width="10%">ìƒíƒœ</th>
                <th width="10%">ì‹œê°„</th>
                <th>ìƒì„¸ ì •ë³´</th>
            </tr>
        </thead>
        <tbody id="resultTableBody"></tbody>
    </table>
</div>

<script>
    window.onload = function() {
        renderApiList();
    };

    function renderApiList() {
        // [UPDATED] ë©¤ë²„ API OPA ë²ˆí˜¸ ë°˜ì˜
        const apiData = [
            { code: "OPA 003", method: "GET", name: "ë¬¸ì„œ ì •ë³´ ì¡°íšŒ" },
            { code: "OPA 004", method: "GET", name: "ë¬¸ì„œ íŒŒì¼ ë‹¤ìš´ë¡œë“œ" },
            { code: "OPA 005", method: "POST", name: "ìƒˆ ë¬¸ì„œ ì‘ì„± (ë‚´ë¶€)" },
            { code: "OPA 006", method: "GET", name: "ë¬¸ì„œ ì²¨ë¶€ íŒŒì¼ ë‹¤ìš´ë¡œë“œ" },
            { code: "OPA 007", method: "POST", name: "ìƒˆ ë¬¸ì„œ ì‘ì„± (ì™¸ë¶€)" },
            { code: "OPA 008", method: "POST", name: "ë¬¸ì„œ ëª©ë¡ ì¡°íšŒ" },
            { code: "OPA 009", method: "DELETE", name: "ë¬¸ì„œ ì‚­ì œ" },
            { code: "OPA 010", method: "GET", name: "ë©¤ë²„ ëª©ë¡ ì¡°íšŒ" },
            { code: "OPA 011", method: "POST", name: "ë©¤ë²„ ì¶”ê°€" },
            { code: "OPA 012", method: "PATCH", name: "ë©¤ë²„ ìˆ˜ì •" },
            { code: "OPA 013", method: "DELETE", name: "ë©¤ë²„ ì‚­ì œ" },
            { code: "OPA 014", method: "POST", name: "ìˆ˜ì‹ ì ë¬¸ì„œ ì¬ìš”ì²­" },
            { code: "OPA 015", method: "GET", name: "ì‘ì„± ê°€ëŠ¥í•œ í…œí”Œë¦¿ ëª©ë¡" },
            { code: "OPA 016", method: "POST", name: "ë¬¸ì„œ ì¼ê´„ ì‘ì„±" },
            { code: "OPA 017", method: "GET", name: "ê·¸ë£¹ ëª©ë¡ ì¡°íšŒ" },
            { code: "OPA 018", method: "POST", name: "ê·¸ë£¹ ì¶”ê°€" },
            { code: "OPA 019", method: "PATCH", name: "ê·¸ë£¹ ìˆ˜ì •" },
            { code: "OPA 020", method: "DELETE", name: "ê·¸ë£¹ ì‚­ì œ" },
            { code: "OPA 021", method: "POST", name: "ë¬¸ì„œ ì¼ê´„ ì‘ì„± (ë©€í‹°)" },
            { code: "OPA 042", method: "POST", name: "ë¬¸ì„œ ì·¨ì†Œ" }
        ];

        const container = document.getElementById('apiListContainer');
        let html = "";
        
        apiData.forEach(api => {
            let badgeClass = "bg-secondary";
            if(api.method === "GET") badgeClass = "bg-primary";
            else if(api.method === "POST") badgeClass = "bg-success";
            else if(api.method === "PATCH") badgeClass = "bg-warning text-dark";
            else if(api.method === "DELETE") badgeClass = "bg-danger";

            html += `
                <div class="col-md-4 col-sm-6">
                    <div class="opa-badge">
                        <span class="badge ${badgeClass} method-badge">${api.method}</span>
                        <div>
                            <span class="opa-code">${api.code}</span>
                            <span class="opa-name">${api.name}</span>
                        </div>
                    </div>
                </div>
            `;
        });
        container.innerHTML = html;
    }

    // [UI Helper] í•„ë“œ ì¶”ê°€
    function addFieldRow(containerId = 'fieldsContainer') {
        const container = document.getElementById(containerId);
        const div = document.createElement('div');
        div.className = 'field-row row g-2 align-items-center';
        div.innerHTML = `
            <div class="col-5"><input type="text" class="form-control form-control-sm field-id" placeholder="ID"></div>
            <div class="col-6"><input type="text" class="form-control form-control-sm field-value" placeholder="Value"></div>
            <div class="col-1 text-center"><button class="btn btn-sm btn-close" onclick="this.closest('.field-row').remove()"></button></div>
        `;
        container.appendChild(div);
    }

    function getFieldsArray(containerId = 'fieldsContainer') {
        const container = document.getElementById(containerId);
        if (!container) return [];
        const rows = container.querySelectorAll('.field-row');
        const fields = [];
        rows.forEach(row => {
            const id = row.querySelector('.field-id').value;
            const value = row.querySelector('.field-value').value;
            if(id) fields.push({ "id": id, "value": value });
        });
        return fields;
    }

    // [Logic] ë°ì´í„° ìˆ˜ì§‘
    const getDynamicData = () => {
        return {
            email: document.getElementById('targetEmail').value,
            name: document.getElementById('targetName').value,
            phone: document.getElementById('targetPhone').value,
            templateId: document.getElementById('targetTemplateId').value,
            companyId: document.getElementById('companyId').value,
            extTemplateId: document.getElementById('extTemplateId').value,
            companyApiKey: document.getElementById('companyApiKey').value,
            downloadDocId: document.getElementById('downloadDocId').value,
            attachDocId: document.getElementById('attachDocId').value,
            memberId: document.getElementById('memberId').value,
            templateId2: document.getElementById('targetTemplateId2').value,
            email2: document.getElementById('targetEmail2').value,
            name2: document.getElementById('targetName2').value,
            phone2: document.getElementById('targetPhone2').value
        };
    };

    // [Refactoring] ë¬¸ì„œ ë‚´ë¶€ ë°ì´í„° ìƒì„±
    const getInnerDocumentData = (email, name, phone, fieldsArr) => {
        let recipientsList = [];
        const hasRecipientInfo = (email && email.trim() !== "") || (name && name.trim() !== "") || (phone && phone.trim() !== "");
        if (hasRecipientInfo) {
            recipientsList.push({
                "step_type": "05", "use_mail": true, "use_sms": true,
                "member": { "id": email, "name": name, "sms": { "country_code": "82", "phone_number": phone } },
                "auth": { "password": "", "valid": { "day": 0, "hour": 0 } }
            });
        }
        return { "fields": fieldsArr, "recipients": recipientsList, "parameters": [], "notification": [] };
    };

    const generateDocumentBody = () => {
        const data = getDynamicData();
        const commonFields = getFieldsArray('fieldsContainer');
        return { "document": getInnerDocumentData(data.email, data.name, data.phone, commonFields) };
    };

    const generateMassDocumentBody = () => {
        const data = getDynamicData();
        const commonFields = getFieldsArray('fieldsContainer');
        const innerData = getInnerDocumentData(data.email, data.name, data.phone, commonFields);
        return { "documents": [ { ...innerData, "select_group_name": "" }, { ...innerData, "select_group_name": "" } ] };
    };

    const generateMassMultiDocumentBody = () => {
        const data = getDynamicData();
        const doc1Fields = getFieldsArray('fieldsContainer');
        const doc1 = { "template_id": data.templateId, ...getInnerDocumentData(data.email, data.name, data.phone, doc1Fields) };
        const doc2Fields = getFieldsArray('fieldsContainer2');
        const doc2 = { "template_id": data.templateId2, ...getInnerDocumentData(data.email2, data.name2, data.phone2, doc2Fields) };
        const docs = [doc1];
        if(data.templateId2) docs.push(doc2);
        return { "documents": docs };
    };

    const generateReRequestBody = () => {
        const data = getDynamicData();
        if (!data.email && !data.name && !data.phone) return null;
        return { "input": { "next_steps": [{ "step_type": "05", "step_seq": "2", "recipients": [{ "member": { "name": data.name, "id": data.email, "sms": { "country_code": "+82", "phone_number": data.phone } }, "use_mail": true, "use_sms": true }], "comment": "ì¬ìš”ì²­ API í…ŒìŠ¤íŠ¸ì…ë‹ˆë‹¤." }] } };
    };
    const generateListBody = () => { return { "type": "04", "title_and_content": "", "title": "", "content": "", "limit": "100", "skip": "0" }; };

    // [Store]
    let sharedData = { lastCreatedId: null, createdIdList: [], createdGroupId: null };

    // [TEST LIST]
    const testList = [
        // 1. OPA 005
        {
            name: "ìƒˆ ë¬¸ì„œ ì‘ì„± (OPA 005 - ë‚´ë¶€)",
            method: "POST",
            path: () => {
                const data = getDynamicData();
                if(!data.templateId) throw new Error("ë‚´ë¶€ìš© Template ID ëˆ„ë½");
                return `/v2.0/api/documents?template_id=${data.templateId}`;
            },
            body: generateDocumentBody,
            expectedStatus: 200,
            afterRequest: (json) => {
                if(json && json.document && json.document.id) {
                    sharedData.lastCreatedId = json.document.id;
                    sharedData.createdIdList.push(json.document.id);
                }
            }
        },
        // 2. OPA 003
        {
            name: "ë¬¸ì„œ ì •ë³´ ì¡°íšŒ - ê¸°ë³¸ (OPA 003)",
            method: "GET",
            path: () => {
                if(!sharedData.lastCreatedId) throw new Error("ì‘ì„±ëœ ë¬¸ì„œ ì—†ìŒ");
                return `/v2.0/api/documents/${sharedData.lastCreatedId}`;
            },
            body: null,
            expectedStatus: 200
        },
        // 3. OPA 003 Detailed
        {
            name: "ë¬¸ì„œ ì •ë³´ ì¡°íšŒ - ìƒì„¸ (OPA 003)",
            method: "GET",
            path: () => {
                if(!sharedData.lastCreatedId) throw new Error("ì‘ì„±ëœ ë¬¸ì„œ ì—†ìŒ");
                return `/v2.0/api/documents/${sharedData.lastCreatedId}?include_fields=true&include_histories=true&include_previous_status=true&include_next_status=true&include_external_token=true&include_detail_template_info=true`;
            },
            body: null,
            expectedStatus: 200
        },
        // 4. OPA 004
        {
            name: "ë¬¸ì„œ íŒŒì¼ ë‹¤ìš´ë¡œë“œ (OPA 004)",
            method: "GET",
            path: () => {
                const data = getDynamicData();
                if(!data.downloadDocId) throw new Error("ë‹¤ìš´ë¡œë“œìš© ID ëˆ„ë½");
                return `/v2.0/api/documents/${data.downloadDocId}/download_files?file_type=document,audit_trail`;
            },
            body: null,
            expectedStatus: 200
        },
        // 5. OPA 006
        {
            name: "ë¬¸ì„œ ì²¨ë¶€ íŒŒì¼ ë‹¤ìš´ë¡œë“œ (OPA 006)",
            method: "GET",
            path: () => {
                const data = getDynamicData();
                if(!data.attachDocId) throw new Error("ì²¨ë¶€íŒŒì¼ìš© ID ëˆ„ë½");
                return `/v2.0/api/documents/${data.attachDocId}/download_attach_files`;
            },
            body: null,
            expectedStatus: 200
        },
        // 6. OPA 14 Re-request
        {
            name: "ìˆ˜ì‹ ì ë¬¸ì„œ ì¬ìš”ì²­ (OPA 014)",
            method: "POST",
            path: () => {
                if(!sharedData.lastCreatedId) throw new Error("ì•ì„œ ìƒì„±ëœ ë¬¸ì„œê°€ ì—†ì–´ ì¬ìš”ì²­ ë¶ˆê°€");
                return `/v2.0/api/documents/${sharedData.lastCreatedId}/re_request_outsider`;
            },
            body: generateReRequestBody, 
            expectedStatus: 200
        },
        // 7. OPA 007
        {
            name: "ìƒˆ ë¬¸ì„œ ì‘ì„± (OPA 007 - ì™¸ë¶€)",
            method: "POST",
            path: () => {
                const data = getDynamicData();
                if(!data.companyId || !data.extTemplateId) throw new Error("ì™¸ë¶€ìš© í•„ìˆ˜ê°’ ëˆ„ë½");
                return `/v2.0/api/documents/external?company_id=${data.companyId}&template_id=${data.extTemplateId}`;
            },
            headers: () => {
                const data = getDynamicData();
                if(!data.companyApiKey) throw new Error("API Key ëˆ„ë½");
                return { "Authorization": `Bearer ${btoa(data.companyApiKey)}` };
            },
            body: generateDocumentBody,
            expectedStatus: 200,
            afterRequest: (json) => {
                if(json && json.document && json.document.id) {
                    sharedData.lastCreatedId = json.document.id;
                    sharedData.createdIdList.push(json.document.id);
                }
            }
        },
        // 8. OPA 008 Basic
        {
            name: "ë¬¸ì„œ ëª©ë¡ ì¡°íšŒ - ê¸°ë³¸ (OPA 008)",
            method: "POST",
            path: "/v2.0/api/list_document",
            body: generateListBody,
            expectedStatus: 200
        },
        // 9. OPA 008 Detailed
        {
            name: "ë¬¸ì„œ ëª©ë¡ ì¡°íšŒ - ìƒì„¸ (OPA 008)",
            method: "POST",
            path: "/v2.0/api/list_document?include_fields=true&include_histories=true&include_previous_status=true&include_next_status=true&include_external_token=true&include_detail_template_info=true",
            body: generateListBody,
            expectedStatus: 200
        },
        // 10. OPA 015
        {
            name: "ì‘ì„± ê°€ëŠ¥í•œ í…œí”Œë¦¿ ëª©ë¡ ì¡°íšŒ (OPA 015)",
            method: "GET",
            path: "/v2.0/api/forms",
            body: null,
            expectedStatus: 200
        },
        // 11. OPA 016 Mass Create
        {
            name: "ë¬¸ì„œ ì¼ê´„ ì‘ì„± (OPA 016)",
            method: "POST",
            path: () => {
                const data = getDynamicData();
                if(!data.templateId) throw new Error("ë‚´ë¶€ìš© Template ID ëˆ„ë½");
                return `/v2.0/api/forms/mass_documents?template_id=${data.templateId}`;
            },
            body: generateMassDocumentBody,
            expectedStatus: 200,
            afterRequest: (json) => {
                if(json && json.documents && Array.isArray(json.documents)) {
                    json.documents.forEach(doc => { if(doc.id) sharedData.createdIdList.push(doc.id); });
                    console.log(`[OPA 016] ${json.documents.length} created IDs added to cleanup list.`);
                }
            }
        },
        // 12. OPA 021 Multi-Mass Create
        {
            name: "ë¬¸ì„œ ì¼ê´„ ì‘ì„± - ë©€í‹° í…œí”Œë¦¿ (OPA 021)",
            method: "POST",
            path: "/v2.0/api/forms/mass_multi_documents",
            body: generateMassMultiDocumentBody,
            expectedStatus: 200,
            afterRequest: (json) => {
                if(json && json.documents && Array.isArray(json.documents)) {
                    json.documents.forEach(doc => { if(doc.id) sharedData.createdIdList.push(doc.id); });
                    console.log(`[OPA 021] ${json.documents.length} created IDs added to cleanup list.`);
                }
            }
        },

        // --- Cleanup ---
        // 13. OPA 42
        {
            name: "ë¬¸ì„œ ì·¨ì†Œ (OPA 042 - Cleanup)",
            method: "POST",
            path: "/v2.0/api/documents/cancel",
            body: () => {
                if (sharedData.createdIdList.length === 0) throw new Error("ì·¨ì†Œí•  ë¬¸ì„œ ID ì—†ìŒ");
                return { "input": { "document_ids": sharedData.createdIdList } };
            },
            expectedStatus: 200
        },
        // 14. OPA 009
        {
            name: "ë¬¸ì„œ ì‚­ì œ (OPA 009 - Cleanup)",
            method: "DELETE",
            path: "/v2.0/api/documents",
            body: () => {
                if (sharedData.createdIdList.length === 0) throw new Error("ì‚­ì œí•  ë¬¸ì„œ ID ì—†ìŒ");
                return { "document_ids": sharedData.createdIdList };
            },
            expectedStatus: 200
        },

        // --- Member APIs ---
        // 15. Member Create
        {
            name: "ë©¤ë²„ ì¶”ê°€ (OPA 011)",
            method: "POST",
            path: "/v2.0/api/members?mailOption=false",
            body: () => {
                const data = getDynamicData();
                if(!data.memberId) throw new Error("ë©¤ë²„ IDë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");
                return { "account": { "id": data.memberId, "password": "forcs0421!@", "first_name": "í…ŒìŠ¤í„°", "external_sso_info": { "uuid": "123", "account_id": "test" } } };
            },
            expectedStatus: 200
        },
        // 16. Member List
        {
            name: "ë©¤ë²„ ëª©ë¡ ì¡°íšŒ (OPA 010)",
            method: "GET",
            path: "/v2.0/api/members",
            body: null,
            expectedStatus: 200
        },
        // 17. Member Update
        {
            name: "ë©¤ë²„ ìˆ˜ì • (OPA 012)",
            method: "PATCH",
            path: () => {
                const data = getDynamicData();
                if(!data.memberId) throw new Error("ë©¤ë²„ ID ëˆ„ë½");
                return `/v2.0/api/members/${data.memberId}`;
            },
            body: () => {
                const data = getDynamicData();
                return {
                    "account": {
                        "id": data.memberId,
                        "name": "í…ŒìŠ¤í„°ìˆ˜ì •",
                        "enabled": true,
                        "contact": { "number": "010-1111-1111", "tel": "010-1234-5678" },
                        "department": "ì—°êµ¬ì†Œ",
                        "position": "ì „ì„ì—°êµ¬ì›",
                        "role": ["template_manager"]
                    }
                };
            },
            expectedStatus: 200
        },
        // 18. Member Delete
        {
            name: "ë©¤ë²„ ì‚­ì œ (OPA 013)",
            method: "DELETE",
            path: () => {
                const data = getDynamicData();
                if(!data.memberId) throw new Error("ë©¤ë²„ ID ëˆ„ë½");
                return `/v2.0/api/members/${data.memberId}`;
            },
            body: null,
            expectedStatus: 200
        },

        // --- Group APIs ---
        // 19. Group List
        {
            name: "ê·¸ë£¹ ëª©ë¡ ì¡°íšŒ (OPA 017)",
            method: "GET",
            path: "/v2.0/api/groups",
            body: null,
            expectedStatus: 200
        },
        // 20. Group Create
        {
            name: "ê·¸ë£¹ ì¶”ê°€ (OPA 018)",
            method: "POST",
            path: "/v2.0/api/groups",
            body: () => {
                const data = getDynamicData();
                if(!data.memberId) throw new Error("ë©¤ë²„ ID ëˆ„ë½");
                return {
                    "group": {
                        "name": "í…ŒìŠ¤íŠ¸ê·¸ë£¹",
                        "description": "í´ë¼ìš°ë“œíŒ€",
                        "members": [ data.memberId ]
                    }
                };
            },
            expectedStatus: 200,
            afterRequest: (json) => {
                if(json && json.group && json.group.id) {
                    sharedData.createdGroupId = json.group.id;
                }
            }
        },
        // 21. Group Update
        {
            name: "ê·¸ë£¹ ìˆ˜ì • (OPA 019)",
            method: "PATCH",
            path: () => {
                if(!sharedData.createdGroupId) throw new Error("ê·¸ë£¹ ID ì—†ìŒ");
                return `/v2.0/api/groups/${sharedData.createdGroupId}`;
            },
            body: () => {
                const data = getDynamicData();
                return {
                    "group": {
                        "name": "í…ŒìŠ¤íŠ¸ê·¸ë£¹2",
                        "description": "í´ë¼ìš°ë“œ2íŒ€",
                        "members": [ data.memberId ]
                    }
                };
            },
            expectedStatus: 200
        },
        // 22. Group Delete
        {
            name: "ê·¸ë£¹ ì‚­ì œ (OPA 020)",
            method: "DELETE",
            path: "/v2.0/api/groups",
            body: () => {
                if(!sharedData.createdGroupId) throw new Error("ì‚­ì œí•  ê·¸ë£¹ ID ì—†ìŒ");
                return { "group_ids": [ sharedData.createdGroupId ] };
            },
            expectedStatus: 200
        }
    ];

    async function runAllTests() {
        const baseUrl = document.getElementById('baseUrl').value.replace(/\/$/, "");
        const commonToken = document.getElementById('accessToken').value;
        const tbody = document.getElementById('resultTableBody');
        const progressBar = document.getElementById('progressBar');
        const progressText = document.getElementById('progressText');

        tbody.innerHTML = "";
        sharedData.lastCreatedId = null;
        sharedData.createdIdList = []; 
        sharedData.createdGroupId = null;
        let successCount = 0;
        let failCount = 0;

        for (let i = 0; i < testList.length; i++) {
            const test = testList[i];
            let url = "";
            let bodyData = null;
            let errorMessage = "";
            let responseJson = null;

            const percent = Math.round(((i + 1) / testList.length) * 100);
            progressBar.style.width = `${percent}%`;
            progressText.innerText = `Testing... ${test.name}`;

            try {
                const pathStr = typeof test.path === 'function' ? test.path() : test.path;
                url = `${baseUrl}${pathStr}`;
                if (test.body) {
                    const generatedBody = typeof test.body === 'function' ? test.body() : test.body;
                    if (generatedBody === null && test.name.includes("OPA 014")) {
                        throw new Error("SKIP_OPA14");
                    }
                    bodyData = generatedBody;
                }
            } catch (err) { errorMessage = err.message; }

            if (errorMessage === "SKIP_OPA14") {
                const rowId = `log-${i}`;
                const row = `
                    <tr class="table-warning">
                        <td class="text-center fw-bold">${i + 1}</td>
                        <td><div class="fw-bold">${test.name}</div><div class="small text-muted">Skipped</div></td>
                        <td class="text-center"><span class="badge bg-secondary">${test.method}</span></td>
                        <td class="text-center status-skip">SKIPPED</td>
                        <td class="text-center">-</td>
                        <td class="text-center"><button class="btn btn-sm btn-outline-secondary" onclick="toggleLog('${rowId}')">ê²°ê³¼ë³´ê¸°</button></td>
                    </tr>
                    <tr><td colspan="6" class="p-0 border-0"><div id="${rowId}" class="log-box">ìˆ˜ì‹ ì ì •ë³´ê°€ ì—†ì–´ ê±´ë„ˆëœ€</div></td></tr>
                `;
                tbody.insertAdjacentHTML('beforeend', row);
                continue; 
            }

            let requestHeaders = {
                "Content-Type": "application/json",
                ...(commonToken ? { "Authorization": `Bearer ${commonToken}` } : {})
            };

            if (test.headers) {
                try {
                    const customHeaders = typeof test.headers === 'function' ? test.headers() : test.headers;
                    requestHeaders = { ...requestHeaders, ...customHeaders };
                } catch (e) { errorMessage = e.message; }
            }

            const options = { method: test.method, headers: requestHeaders };
            if (bodyData) options.body = JSON.stringify(bodyData);

            const startTime = performance.now();
            let resultStatus = "ERROR";
            let resultClass = "status-fail";
            let rowColor = "table-danger";
            let responseText = errorMessage;
            let duration = "-";

            if (!errorMessage) {
                try {
                    const response = await fetch(url, options);
                    const endTime = performance.now();
                    duration = (endTime - startTime).toFixed(0) + "ms";

                    const contentType = response.headers.get("content-type");
                    if (contentType && (contentType.includes("pdf") || contentType.includes("zip") || contentType.includes("octet-stream") || contentType.includes("image"))) {
                        const blob = await response.blob();
                        responseText = `[Binary File] Type: ${contentType}, Size: ${blob.size} bytes`;
                        responseJson = null;
                    } else {
                        const text = await response.text();
                        responseText = text;
                        try {
                            responseJson = JSON.parse(text);
                            responseText = JSON.stringify(responseJson, null, 2);
                        } catch(e) { }
                    }

                    if (response.status === test.expectedStatus) {
                        resultStatus = "PASS";
                        resultClass = "status-pass";
                        rowColor = ""; 
                        successCount++;
                        if(test.afterRequest && responseJson) test.afterRequest(responseJson);
                    } else {
                        resultStatus = `FAIL (${response.status})`;
                        failCount++;
                    }
                } catch (networkError) {
                    responseText = `Network Error: ${networkError.message}`;
                    failCount++;
                }
            } else {
                failCount++;
            }

            const rowId = `log-${i}`;
            const row = `
                <tr class="${rowColor}">
                    <td class="text-center fw-bold">${i + 1}</td>
                    <td>
                        <div class="fw-bold">${test.name}</div>
                        <div class="small text-muted text-break">${url}</div>
                    </td>
                    <td class="text-center"><span class="badge bg-secondary">${test.method}</span></td>
                    <td class="text-center ${resultClass}">${resultStatus}</td>
                    <td class="text-center">${duration}</td>
                    <td class="text-center">
                        <button class="btn btn-sm btn-outline-secondary" onclick="toggleLog('${rowId}')">ê²°ê³¼ë³´ê¸°</button>
                    </td>
                </tr>
                <tr>
                    <td colspan="6" class="p-0 border-0">
                        <div id="${rowId}" class="log-box">
                            <div class="text-primary fw-bold">[Request Body]</div>
                            ${bodyData ? JSON.stringify(bodyData, null, 2) : "(Empty)"}
                            <hr class="my-1">
                            <div class="text-success fw-bold">[Response]</div>
                            ${responseText}
                        </div>
                    </td>
                </tr>
            `;
            tbody.insertAdjacentHTML('beforeend', row);
            
            await new Promise(r => setTimeout(r, 500));
        }

        progressText.innerText = `ì™„ë£Œ! (ì„±ê³µ: ${successCount} / ì‹¤íŒ¨: ${failCount})`;
        progressBar.classList.remove('progress-bar-animated');
        progressBar.classList.add(failCount > 0 ? 'bg-danger' : 'bg-success');
    }

    function toggleLog(id) {
        const box = document.getElementById(id);
        box.style.display = (box.style.display === "block") ? "none" : "block";
    }
</script>

</body>
</html>