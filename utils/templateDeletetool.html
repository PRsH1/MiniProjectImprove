<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>eformsign 템플릿 일괄 삭제 도구</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jsrsasign/10.5.25/jsrsasign-all-min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        #logConsole::-webkit-scrollbar { width: 8px; }
        #logConsole::-webkit-scrollbar-track { background: #1f2937; }
        #logConsole::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 4px; }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 font-sans p-6">

    <div class="max-w-5xl mx-auto bg-white shadow-xl rounded-lg p-8">
        <div class="flex justify-between items-center border-b pb-4 mb-6">
            <h1 class="text-3xl font-bold text-red-700 flex items-center">
                <i class="fas fa-file-signature mr-3"></i>eformsign 템플릿 삭제 도구
                <span class="ml-3 text-sm font-normal text-white bg-red-600 px-3 py-1 rounded-full">Template Delete Manager</span>
            </h1>
            <div id="wakeLockStatus" class="hidden text-sm font-bold text-green-600 flex items-center animate-pulse">
                <i class="fas fa-lightbulb mr-2"></i>화면 켜짐 유지 중
            </div>
        </div>
        
        <div class="bg-red-50 border-l-4 border-red-500 p-4 mb-8 shadow-sm">
            <h3 class="text-lg font-bold text-red-800">⚠️ 사용 전 필독</h3>
            <ul class="list-disc list-inside mt-2 text-sm text-red-700 space-y-1">
                <li>템플릿 삭제는 <strong>복구가 불가능</strong>하며, 관련 문서 조회에 영향을 줄 수 있습니다.</li>
                <li><strong>검색 조건(날짜, 이름, 카테고리)</strong>을 정확히 확인 후 진행하세요.</li>
                <li>해당 작업은 대표 관리자 계정으로 진행해주세요</li>
                <li>작업 중 토큰 자동 갱신 및 절전 모드 방지가 작동합니다.</li>
            </ul>
        </div>

        <div class="mb-8 bg-white p-6 rounded-lg border border-gray-200 shadow-sm relative overflow-hidden">
            <div class="absolute top-0 left-0 w-1 h-full bg-indigo-500"></div>
            <h2 class="text-xl font-bold mb-4 text-gray-800 flex items-center">
                <span class="bg-indigo-100 text-indigo-700 w-8 h-8 rounded-full flex items-center justify-center mr-3 text-sm">1</span>
                인증 정보 설정
            </h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="col-span-2">
                    <label class="block text-sm font-bold text-gray-700 mb-2">환경</label>
                    <select id="envSelection" onchange="updateDomain()" class="w-full p-3 border rounded focus:ring-2 focus:ring-indigo-500 outline-none">
                        <option value="op_saas">운영 (SaaS) - kr-api.eformsign.com</option>
                        <option value="csap">공공 (CSAP) - www.gov-eformsign.com</option>
                        <option value="custom">직접 입력 (Custom)</option>
                    </select>
                    <div id="customDomainWrapper" class="hidden mt-2">
                        <input type="text" id="customDomainInput" placeholder="https://api.example.com" oninput="updateDomain()" class="w-full p-2 border bg-gray-50 rounded text-sm">
                    </div>
                </div>
                <div><label class="block text-sm font-bold mb-2">API Key</label><input type="text" id="apiKey" class="w-full p-3 border rounded"></div>
                <div><label class="block text-sm font-bold mb-2">Member ID</label><input type="text" id="memberId" class="w-full p-3 border rounded"></div>
                <div class="col-span-2">
                    <div class="flex items-center space-x-6 mb-3">
                        <label class="inline-flex items-center"><input type="radio" name="secretMethod" value="signature" checked onclick="toggleSecretPlaceholder()" class="mr-2">Signature</label>
                        <label class="inline-flex items-center"><input type="radio" name="secretMethod" value="bearer" onclick="toggleSecretPlaceholder()" class="mr-2">Bearer Token</label>
                    </div>
                    <input type="password" id="secretKey" placeholder="Private Key (Hex)" class="w-full p-3 border rounded font-mono text-sm">
                </div>
                <input type="hidden" id="currentAccessToken"><input type="hidden" id="currentDomain">
            </div>
        </div>
        
        <div class="mb-8 bg-white p-6 rounded-lg border border-gray-200 shadow-sm relative overflow-hidden">
            <div class="absolute top-0 left-0 w-1 h-full bg-green-500"></div>
            <h2 class="text-xl font-bold mb-4 text-gray-800 flex items-center">
                <span class="bg-green-100 text-green-700 w-8 h-8 rounded-full flex items-center justify-center mr-3 text-sm">2</span>
                템플릿 검색 조건
            </h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                <div>
                    <label class="block text-sm font-bold text-gray-700 mb-3">날짜 필터링 기준</label>
                    <div class="flex space-x-4 mb-4 bg-gray-50 p-3 rounded border">
                        <label class="inline-flex items-center cursor-pointer">
                            <input type="radio" name="dateType" value="create_date" checked class="form-radio text-green-600">
                            <span class="ml-2 text-sm">생성일 (Create Date)</span>
                        </label>
                        <label class="inline-flex items-center cursor-pointer">
                            <input type="radio" name="dateType" value="update_date" class="form-radio text-green-600">
                            <span class="ml-2 text-sm">수정일 (Update Date)</span>
                        </label>
                    </div>
                    <div class="flex space-x-2">
                        <div class="flex-1"><span class="text-xs text-gray-500 block mb-1">시작일</span><input type="date" id="startDate" class="w-full p-2 border rounded"></div>
                        <div class="flex-1"><span class="text-xs text-gray-500 block mb-1">종료일</span><input type="date" id="endDate" class="w-full p-2 border rounded"></div>
                    </div>
                </div>

                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-1">카테고리 (Category)</label>
                        <input type="text" id="categoryInput" placeholder="카테고리명 포함 (API 검색)" class="w-full p-2 border rounded focus:ring-2 focus:ring-green-500">
                        <p class="text-xs text-gray-400 mt-1">* 해당 문자열을 포함하는 카테고리를 1차 검색합니다.</p>
                    </div>
                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-1">템플릿 이름 (Name)</label>
                        <input type="text" id="nameInput" placeholder="템플릿 이름 포함 (결과 내 검색)" class="w-full p-2 border rounded focus:ring-2 focus:ring-green-500">
                        <p class="text-xs text-gray-400 mt-1">* 조회된 결과 중에서 이름이 포함된 것만 남깁니다.</p>
                    </div>
                </div>
            </div>
        </div>

        <div class="flex space-x-4 mb-8">
            <button id="searchBtn" onclick="startProcess()" class="flex-1 bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-4 px-6 rounded-lg shadow-md transition transform hover:-translate-y-0.5 flex justify-center items-center text-lg">
                <i class="fas fa-search mr-2"></i>1. 토큰 발급 및 조회
            </button>
            <button id="deleteBtn" onclick="confirmDelete()" disabled class="flex-1 bg-gray-300 text-gray-500 font-bold py-4 px-6 rounded-lg shadow-sm cursor-not-allowed transition flex justify-center items-center text-lg">
                <i class="fas fa-trash-alt mr-2"></i>2. 템플릿 삭제 실행
            </button>
        </div>

        <div id="progressContainer" class="hidden mb-6 bg-white p-4 rounded-lg border shadow-sm">
            <div class="flex justify-between mb-2">
                <span id="progressStatusLabel" class="text-sm font-bold text-indigo-700 flex items-center">
                    <i class="fas fa-spinner fa-spin mr-2"></i>작업 진행 중...
                </span>
                <span id="progressText" class="text-sm font-bold text-indigo-700">0% (0/0)</span>
            </div>
            <div class="w-full bg-gray-200 rounded-full h-5 overflow-hidden">
                <div id="progressBar" class="bg-gradient-to-r from-red-500 to-orange-600 h-5 rounded-full transition-all duration-300" style="width: 0%"></div>
            </div>
            <div class="mt-2 text-xs font-bold flex justify-end space-x-4">
                <span class="text-green-600"><i class="fas fa-check-circle mr-1"></i>성공: <span id="successCount">0</span></span>
                <span class="text-red-600"><i class="fas fa-times-circle mr-1"></i>실패: <span id="failCount">0</span></span>
            </div>
        </div>

        <div id="statusArea" class="hidden mb-4 p-5 rounded bg-green-50 border border-green-200 shadow-sm">
            <div class="flex justify-between items-end">
                <div>
                    <span class="text-lg text-gray-700 block">검색된 템플릿: <span id="foundCount" class="font-bold text-green-700 text-2xl mx-1">0</span> 건</span>
                    <span class="text-sm text-gray-500 mt-1" id="filterSummaryDisplay"></span>
                </div>
            </div>
        </div>

        <div class="bg-gray-900 rounded-lg p-4 shadow-inner">
            <div class="flex justify-between items-center mb-2 border-b border-gray-700 pb-2">
                <span class="text-gray-400 text-xs font-mono">SYSTEM LOG</span>
                <button onclick="document.getElementById('logConsole').innerHTML=''" class="text-xs text-gray-500 hover:text-white">Clear</button>
            </div>
            <div class="h-80 overflow-y-auto font-mono text-xs leading-relaxed" id="logConsole">
                <p class="text-green-400">> 시스템 준비 완료.</p>
            </div>
        </div>
    </div>

    <script>
        // --- 전역 설정 ---
        let targetTemplateIds = [];
        let wakeLock = null;
        const BATCH_SIZE = 20; // 템플릿 삭제는 신중하게 20개씩
        const DELAY_MS = 2000; // 2초 딜레이
        const DOMAIN_MAP = { op_saas: 'https://kr-api.eformsign.com', csap: 'https://www.gov-eformsign.com/Service' };

        const today = new Date();
        document.getElementById('startDate').value = `${today.getFullYear()}-01-01`;
        document.getElementById('endDate').value = today.toISOString().split('T')[0];
        updateDomain();

        // --- 유틸리티 ---
        function updateDomain() {
            const val = document.getElementById('envSelection').value;
            const customDiv = document.getElementById('customDomainWrapper');
            const hidden = document.getElementById('currentDomain');
            if (val === 'custom') {
                customDiv.classList.remove('hidden');
                hidden.value = document.getElementById('customDomainInput').value.replace(/\/$/, '');
            } else {
                customDiv.classList.add('hidden');
                hidden.value = DOMAIN_MAP[val];
            }
        }

        function toggleSecretPlaceholder() {
            const method = document.querySelector('input[name="secretMethod"]:checked').value;
            document.getElementById('secretKey').placeholder = method === 'signature' ? "Private Key (Hex)" : "Bearer Token";
        }

        function setButtonState(mode) {
            const searchBtn = document.getElementById('searchBtn');
            const deleteBtn = document.getElementById('deleteBtn');

            if (mode === 'loading') {
                searchBtn.disabled = true; searchBtn.classList.add('bg-gray-300', 'cursor-not-allowed'); searchBtn.classList.remove('bg-indigo-600', 'hover:bg-indigo-700');
                deleteBtn.disabled = true; deleteBtn.classList.add('bg-gray-300', 'cursor-not-allowed'); deleteBtn.classList.remove('bg-gray-300', 'text-gray-500', 'cursor-not-allowed'); // Remove old disabled style
                deleteBtn.classList.remove('bg-red-600', 'hover:bg-red-700', 'shadow-md', 'text-white');
            } else if (mode === 'search_done') {
                searchBtn.disabled = false; searchBtn.classList.remove('bg-gray-300', 'cursor-not-allowed'); searchBtn.classList.add('bg-indigo-600', 'hover:bg-indigo-700');
                if (targetTemplateIds.length > 0) {
                    deleteBtn.disabled = false; 
                    deleteBtn.classList.remove('bg-gray-300', 'text-gray-500', 'cursor-not-allowed');
                    deleteBtn.classList.add('bg-red-600', 'hover:bg-red-700', 'text-white', 'shadow-md');
                } else {
                    deleteBtn.disabled = true; deleteBtn.classList.add('bg-gray-300', 'text-gray-500', 'cursor-not-allowed');
                }
            } else if (mode === 'delete_done' || mode === 'error') {
                searchBtn.disabled = false; searchBtn.classList.add('bg-indigo-600'); searchBtn.classList.remove('bg-gray-300', 'cursor-not-allowed');
                deleteBtn.disabled = true; deleteBtn.classList.add('bg-gray-300', 'text-gray-500', 'cursor-not-allowed'); deleteBtn.classList.remove('bg-red-600');
            }
        }

        function log(msg, type = 'info') {
            const box = document.getElementById('logConsole');
            const p = document.createElement('p');
            p.innerText = `[${new Date().toLocaleTimeString()}] ${msg}`;
            if (type === 'error') p.className = 'text-red-400 font-bold';
            else if (type === 'success') p.className = 'text-green-400 font-bold';
            else if (type === 'warning') p.className = 'text-orange-400 font-bold';
            else if (type === 'system') p.className = 'text-blue-300';
            else p.className = 'text-gray-300';
            box.appendChild(p); box.scrollTop = box.scrollHeight;
        }

        async function requestWakeLock() {
            try { if ('wakeLock' in navigator) { wakeLock = await navigator.wakeLock.request('screen'); document.getElementById('wakeLockStatus').classList.remove('hidden'); } } catch (err) {}
        }
        async function releaseWakeLock() {
            if (wakeLock !== null) { await wakeLock.release(); wakeLock = null; document.getElementById('wakeLockStatus').classList.add('hidden'); }
        }

        // --- 1. Access Token 발급 ---
        async function getAccessToken(isRefresh = false) {
            const apiKey = document.getElementById('apiKey').value.trim();
            const memberId = document.getElementById('memberId').value.trim();
            const secretKeyInput = document.getElementById('secretKey').value.trim().replace(/[\r\n\s]/g, '');
            const method = document.querySelector('input[name="secretMethod"]:checked').value;
            const baseUrl = document.getElementById('currentDomain').value;

            if (!apiKey || !memberId || !secretKeyInput || !baseUrl) { alert("인증 정보를 모두 입력해주세요."); return null; }
            if (isRefresh) log("⚠ 토큰 만료. 갱신 시도...", "warning"); else log("토큰 발급 중...", "system");

            try {
                const execTime = Date.now();
                let signature;
                if (method === 'signature') {
                    let keyObj = null;
                    try { keyObj = KEYUTIL.getKey(secretKeyInput); } catch(e){}
                    if(!keyObj) try { keyObj = KEYUTIL.getKeyFromPlainPrivatePKCS8Hex(secretKeyInput); } catch(e){}
                    if(!keyObj) { alert("Secret Key 형식이 올바르지 않습니다."); return null; }
                    const sig = new KJUR.crypto.Signature({ alg: 'SHA256withECDSA' });
                    sig.init(keyObj);
                    sig.updateString(execTime.toString());
                    signature = sig.sign();
                } else { signature = 'Bearer ' + secretKeyInput; }

                const res = await axios.post(`${baseUrl}/v2.0/api_auth/access_token`, 
                    { execution_time: execTime, member_id: memberId },
                    { headers: { 'Authorization': 'Bearer ' + btoa(apiKey), 'eformsign_signature': signature }}
                );
                const token = res.data.oauth_token.access_token;
                document.getElementById('currentAccessToken').value = token;
                log(isRefresh ? "✅ 갱신 성공." : "발급 성공.", "success");
                return token;
            } catch (e) {
                log(`토큰 발급 실패: ${e.message}`, 'error');
                return null;
            }
        }

        // --- 2. 템플릿 조회 (필터링 로직 포함) ---
        async function startProcess() {
            setButtonState('loading');
            document.getElementById('progressContainer').classList.add('hidden');
            const token = await getAccessToken();
            if (!token) { setButtonState('error'); return; }
            await fetchTemplates(token);
        }

        async function fetchTemplates(initialToken) {
            let token = initialToken;
            const baseUrl = document.getElementById('currentDomain').value;
            
            // 필터링 변수 가져오기
            const categoryVal = document.getElementById('categoryInput').value.trim();
            const nameVal = document.getElementById('nameInput').value.trim();
            const startDateStr = document.getElementById('startDate').value;
            const endDateStr = document.getElementById('endDate').value;
            const dateType = document.querySelector('input[name="dateType"]:checked').value; // create_date or update_date

            const startTs = new Date(`${startDateStr}T00:00:00`).getTime();
            const endTs = new Date(`${endDateStr}T23:59:59`).getTime();

            // API URL 구성 (카테고리는 쿼리스트링으로)
            let url = `${baseUrl}/v2.0/api/forms`;
            if(categoryVal) url += `?category=${encodeURIComponent(categoryVal)}`;

            log(`템플릿 조회를 시작합니다.`, 'system');
            if(categoryVal) log(`- API 필터: 카테고리(${categoryVal})`, 'system');
            
            targetTemplateIds = []; // 초기화

            let retryCount = 0;
            let success = false;

            try {
                // 토큰 갱신 재시도 루프
                while(!success && retryCount < 2) {
                    try {
                        const res = await axios.get(url, {
                            headers: { 'Authorization': `Bearer ${token}` }
                        });

                        const templates = res.data.templates || [];
                        let filteredCount = 0;

                        // ★ 클라이언트 사이드 필터링 (날짜 & 이름) ★
                        templates.forEach(tpl => {
                            const tplDate = tpl[dateType]; // create_date or update_date timestamp
                            const tplName = tpl.name;

                            // 1. 날짜 범위 체크
                            if (tplDate >= startTs && tplDate <= endTs) {
                                // 2. 이름 포함 여부 체크 (입력값이 없으면 통과)
                                if (!nameVal || tplName.includes(nameVal)) {
                                    targetTemplateIds.push(tpl.form_id);
                                    filteredCount++;
                                }
                            }
                        });

                        success = true;
                        
                        // 결과 UI 표시
                        document.getElementById('statusArea').classList.remove('hidden');
                        document.getElementById('foundCount').innerText = targetTemplateIds.length.toLocaleString();
                        
                        let summary = `[${dateType === 'create_date' ? '생성일' : '수정일'} 기준] ${startDateStr} ~ ${endDateStr}`;
                        if(nameVal) summary += ` / 이름 포함: "${nameVal}"`;
                        if(categoryVal) summary += ` / 카테고리: "${categoryVal}"`;
                        
                        document.getElementById('filterSummaryDisplay').innerText = summary;

                        if (targetTemplateIds.length > 0) {
                            log(`총 ${templates.length}개 중 조건에 맞는 ${targetTemplateIds.length}개 발견.`, 'success');
                        } else {
                            log(`조건에 맞는 템플릿이 없습니다. (전체: ${templates.length}개)`);
                        }
                        
                        setButtonState('search_done');

                    } catch(error) {
                        if (error.response && error.response.status === 401) {
                            log(`조회 중 토큰 만료. 갱신 시도...`, 'warning');
                            const newToken = await getAccessToken(true);
                            if (newToken) { 
                                token = newToken; 
                                retryCount++; 
                                log(`토큰 갱신됨. 조회 재시도...`, 'system');
                            } else { 
                                throw new Error("토큰 갱신 실패"); 
                            }
                        } else {
                            throw error;
                        }
                    }
                }
            } catch (e) {
                log(`조회 실패: ${e.message}`, 'error');
                setButtonState('error');
            }
        }

        // --- 4. 삭제 로직 ---
        function confirmDelete() {
            const count = targetTemplateIds.length;
            const msg = `[경고: 템플릿 삭제]\n\n총 ${count}개의 템플릿을 영구 삭제하시겠습니까?\n이 작업은 되돌릴 수 없습니다.`;
            if (confirm(msg)) executeBatchDelete();
        }

        async function executeBatchDelete() {
            let token = document.getElementById('currentAccessToken').value;
            const baseUrl = document.getElementById('currentDomain').value;
            const total = targetTemplateIds.length;

            await requestWakeLock();
            setButtonState('loading');
            
            const progressContainer = document.getElementById('progressContainer');
            const progressBar = document.getElementById('progressBar');
            const progressText = document.getElementById('progressText');
            const progressLabel = document.getElementById('progressStatusLabel');
            const elSuccess = document.getElementById('successCount');
            const elFail = document.getElementById('failCount');

            progressContainer.classList.remove('hidden');
            progressBar.style.width = '0%';
            progressText.innerText = `0%`;
            progressLabel.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>삭제 진행 중...';

            let successCnt = 0;
            let failCnt = 0;

            log(`템플릿 삭제 시작 (총 ${total}건)...`, 'warning');

            // 템플릿은 단건 삭제 API이므로 Loop를 돌며 하나씩 요청 (20개씩 끊어서 딜레이)
            for (let i = 0; i < total; i++) {
                const formId = targetTemplateIds[i];
                let retryCount = 0;
                let isDone = false;

                // 20개마다 딜레이 (단, 첫번째는 제외)
                if (i > 0 && i % BATCH_SIZE === 0) {
                    // log(`서버 보호를 위해 ${DELAY_MS/1000}초 대기...`);
                    await new Promise(r => setTimeout(r, DELAY_MS));
                }

                while (!isDone && retryCount < 2) {
                    try {
                        // DELETE 호출
                        await axios.delete(`${baseUrl}/v2.0/api/forms/${formId}`, {
                            headers: { 'Authorization': `Bearer ${token}` }
                        });
                        
                        successCnt++;
                        isDone = true;
                        
                        // 진행률 업데이트 (너무 잦은 업데이트 방지를 위해 5개 단위로 로그)
                        if((i+1) % 5 === 0 || i === total - 1) {
                            const pct = Math.floor(((i + 1) / total) * 100);
                            progressBar.style.width = `${pct}%`;
                            progressText.innerText = `${pct}%`;
                            elSuccess.innerText = successCnt;
                            elFail.innerText = failCnt;
                            log(`[${i+1}/${total}] 삭제 완료`, 'system');
                        }

                    } catch (error) {
                        if (error.response && error.response.status === 401) {
                            log(`삭제 중 토큰 만료. 갱신 시도...`, 'warning');
                            const newToken = await getAccessToken(true);
                            if (newToken) {
                                token = newToken; retryCount++;
                            } else {
                                log(`토큰 갱신 실패. 중단.`, 'error');
                                alert("토큰 갱신 실패"); setButtonState('error'); await releaseWakeLock(); return;
                            }
                        } else {
                            log(`삭제 실패(ID: ${formId}): ${error.message}`, 'error');
                            failCnt++;
                            isDone = true; 
                        }
                    }
                }
            }

            await releaseWakeLock();
            progressBar.style.width = '100%';
            progressLabel.innerHTML = '<i class="fas fa-check-circle mr-2"></i>작업 완료!';
            
            if (failCnt > 0) alert(`작업 완료 (성공: ${successCnt}, 실패: ${failCnt})`);
            else alert("모든 템플릿 삭제가 완료되었습니다.");

            // 초기화
            targetTemplateIds = [];
            document.getElementById('foundCount').innerText = '0';
            setButtonState('delete_done');
        }
    </script>
</body>
</html>