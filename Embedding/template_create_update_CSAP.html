<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <title>í…œí”Œë¦¿ ê´€ë¦¬ (CSAP ê³µê³µ)</title>

    <script src="https://www.gov-eformsign.com/plugins/jquery/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jsrsasign/8.0.20/jsrsasign-all-min.js"></script>
    <script src="https://www.gov-eformsign.com/lib/js/efs_embedded_form.js"></script>

    <style>
        /* --- ê¸°ë³¸ ë ˆì´ì•„ì›ƒ --- */
        body { width: 100%; margin: 0; font-family: Arial, sans-serif; background-color: #e9ecef; color: #333; display: flex; justify-content: center; box-sizing: border-box; }
        .container { display: flex; width: 95%; margin-top: 20px; margin-bottom: 20px; box-sizing: border-box; }
        
        /* --- ì¢Œì¸¡ ì„¤ì • í¼ --- */
        #templateForm { flex: 0 0 450px; margin-right: 20px; background-color: #fff; border: 1px solid #ced4da; border-radius: 8px; padding: 20px; box-shadow: 0 0 12px rgba(0,0,0,0.1); height: fit-content; }
        h2 { text-align: center; color: #2a6592; margin-top: 0; font-size: 1.5rem; }
        h3 { color: #333; border-bottom: 1px solid #ddd; padding-bottom: 5px; margin-top: 20px; font-size: 1.1rem; }
        label { display: block; margin-bottom: 5px; font-weight: bold; color: #495057; font-size: 0.9rem; }
        input[type="text"], input[type="file"], select, textarea { width: 100%; padding: 8px; margin-bottom: 10px; border: 1px solid #ced4da; border-radius: 4px; box-sizing: border-box; }
        button { background-color: #2a6592; color: #fff; padding: 8px; border: none; border-radius: 4px; cursor: pointer; width: 100%; transition: 0.2s; }
        button:hover { background-color: #21507a; }
        
        /* --- ê·¸ë£¹ ìŠ¤íƒ€ì¼ --- */
        .form-group-horizontal { display: flex; gap: 10px; align-items: center; margin-bottom: 10px; }
        .form-group-horizontal * { margin-bottom: 0; }
        .radio-group, .notification-group { display: flex; gap: 15px; padding: 5px 0; flex-wrap: wrap; }
        .radio-group label, .notification-group label { font-weight: normal; display: flex; align-items: center; cursor: pointer; font-size: 0.9rem; }
        .radio-group input, .notification-group input { width: auto; margin-right: 5px; margin-bottom: 0; }

        /* --- í† í° ê²°ê³¼ ë°•ìŠ¤ --- */
        .token-result-box { margin-top: 15px; padding: 15px; background-color: #f8f9fa; border: 1px solid #dee2e6; border-radius: 5px; }
        input[readonly] { background-color: #e9ecef; color: #6c757d; cursor: default; }

        /* --- ìš°ì¸¡ Iframe íŒ¨ë„ --- */
        .iframe-panel { flex: 1; display: flex; flex-direction: column; min-height: 800px; }
        #eformsign_iframe { flex: 1; width: 100%; border: 1px solid #ced4da; border-radius: 8px; background: #fff; }

        /* --- Action ë²„íŠ¼ & ì œì–´ ì˜ì—­ ìŠ¤íƒ€ì¼ (ì´ë™ ê°€ëŠ¥) --- */
        #actionControlArea {
            background: #f8f9fa; border: 1px solid #ced4da; border-radius: 0; 
            padding: 10px; margin-bottom: 0;
        }
        /* Iframe íŒ¨ë„ì— ìˆì„ ë•Œ ìŠ¤íƒ€ì¼ */
        #iframeActionContainer #actionControlArea { border-radius: 8px; margin-bottom: 10px; }
        /* Modal íŒ¨ë„ì— ìˆì„ ë•Œ ìŠ¤íƒ€ì¼ (ìƒë‹¨ë°” ëŠë‚Œ) */
        #modalActionContainer #actionControlArea { border-left: none; border-right: none; border-top: none; border-bottom: 1px solid #ddd; background: #f1f1f1; }

        .switch-wrapper { display: flex; align-items: center; justify-content: flex-end; }
        .switch { position: relative; display: inline-block; width: 40px; height: 20px; margin-right: 8px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 20px; }
        .slider:before { position: absolute; content: ""; height: 16px; width: 16px; left: 2px; bottom: 2px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: #2a6592; }
        input:checked + .slider:before { transform: translateX(20px); }

        #buttonList { display: none; flex-wrap: wrap; gap: 5px; justify-content: center; margin-top: 10px; padding-top: 10px; border-top: 1px solid #ddd; }
        #buttonList button { width: auto; min-width: 80px; background-color: #6c757d; font-size: 0.8rem; display: none; }

        /* --- [í•µì‹¬] Modal(ë ˆì´ì–´ íŒì—…) ìŠ¤íƒ€ì¼ --- */
        #modalWrapper {
            display: none; /* ê¸°ë³¸ ìˆ¨ê¹€ */
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.5); /* ë°˜íˆ¬ëª… ë°°ê²½ */
            z-index: 9999;
            justify-content: center; align-items: center;
        }
        .modal-content {
            width: 90%; height: 90%;
            background-color: #fff; border-radius: 8px;
            display: flex; flex-direction: column;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        .modal-header {
            padding: 15px; border-bottom: 1px solid #eee;
            display: flex; justify-content: space-between; align-items: center;
            background: #fff; border-radius: 8px 8px 0 0;
        }
        .modal-header h3 { margin: 0; font-size: 1.2rem; color: #333; }
        .close-btn {
            background: transparent; color: #999; font-size: 2rem; line-height: 1rem;
            width: auto; border: none; cursor: pointer; padding: 0;
        }
        .close-btn:hover { color: #333; background: transparent; }
        
        /* ëª¨ë‹¬ ë°”ë”” ìŠ¤íƒ€ì¼ */
        .modal-body { flex: 1; padding: 0; position: relative; overflow: hidden; display: flex; flex-direction: column; }
        #eformsign_modal_iframe {
            flex: 1; width: 100%; border: none; border-radius: 0 0 8px 8px;
        }
        /* ëª¨ë‹¬ ìƒë‹¨ Action Container */
        #modalActionContainer { /* í—¤ë” ë°”ë¡œ ì•„ë˜ */ }
    </style>
</head>

<body>

    <div id="modalWrapper">
        <div class="modal-content">
            <div class="modal-header">
                <h3>eformsign Template (CSAP Modal Mode)</h3>
                <button class="close-btn" onclick="closeModal()">&times;</button>
            </div>
            
            <div id="modalActionContainer"></div>

            <div class="modal-body">
                <iframe id="eformsign_modal_iframe" name="eformsign_modal_iframe"></iframe>
            </div>
        </div>
    </div>

    <div class="container">
        <form id="templateForm">
            <h2>í…œí”Œë¦¿ ê´€ë¦¬ (CSAP ê³µê³µ)</h2>

            <h3>1. ì¸ì¦ (Token)</h3>
            <label>User ID:</label>
            <input type="text" id="user_id" placeholder="ë©¤ë²„ ì•„ì´ë”” ì…ë ¥" required />
            <label>API Key:</label>
            <input type="text" id="apiKey" placeholder="API Key ì…ë ¥" required />
            
            <div class="form-group-horizontal">
                <label>Token ë°©ì‹:</label>
                <select id="tokenMethodSelect">
                    <option value="signature">Signature (ë¹„ë°€í‚¤)</option>
                    <option value="bearer">Bearer (ì§ì ‘ ì…ë ¥)</option>
                </select>
            </div>
            <input type="text" id="privateKeyHex" placeholder="Secret Key (Hex) ì…ë ¥" required />
            <button type="button" id="getTokenButton">í† í° ë°œê¸‰ ë°›ê¸°</button>
            
            <div class="token-result-box">
                <label>Access Token (í™•ì¸ìš©):</label>
                <input type="text" id="access_token" readonly placeholder="ë°œê¸‰ ëŒ€ê¸° ì¤‘..." />
                <label>Refresh Token:</label>
                <input type="text" id="refresh_token" readonly placeholder="ë°œê¸‰ ëŒ€ê¸° ì¤‘..." />
                <label>Company ID:</label>
                <input type="text" id="company_id" readonly />
                <input type="hidden" id="company_country_code" value="kr" />
            </div>

            <h3>2. í‘œì‹œ ë°©ì‹ (Display Mode)</h3>
            <div class="radio-group" style="background: #f1f8ff; padding: 15px; border-radius: 4px; border: 1px solid #cfe2ff;">
                <label><input type="radio" name="display_mode" value="iframe" checked /> 1. Iframe (ìš°ì¸¡ í™”ë©´)</label>
                <label><input type="radio" name="display_mode" value="modal" /> 2. Modal (ë ˆì´ì–´ íŒì—…)</label>
            </div>

            <h3>3. í…œí”Œë¦¿ ëª¨ë“œ</h3>
            <select id="mode_type">
                <option value="01">01. í…œí”Œë¦¿ ìƒì„± (New)</option>
                <option value="02">02. í…œí”Œë¦¿ ìˆ˜ì • (Edit)</option>
                <option value="03">03. í…œí”Œë¦¿ ë³µì œ (Copy)</option>
                <option value="04">04. ë¯¸ë¦¬ ë³´ê¸° (Preview)</option>
            </select>

            <div class="form-group-horizontal">
                <label>Type:</label>
                <select id="templateTypeSelect">
                    <option value="form">Form (ì •í˜•)</option>
                    <option value="unstructured_form">Unstructured (ë¹„ì •í˜•)</option>
                </select>
            </div>

            <div id="template_id_section" style="display:none;">
                <label>Template ID:</label>
                <input type="text" id="template_id" placeholder="Template ID ì…ë ¥" />
            </div>

            <h3>4. íŒŒì¼ ë° ì›Œí¬í”Œë¡œìš°</h3>
            <input type="text" id="template_file_name" placeholder="íŒŒì¼ëª… (sample.pdf)" />
            <input type="file" onchange="handleFileSelect(event)" />
            <textarea id="template_file_data" rows="2" placeholder="Base64 ë°ì´í„°" style="display:none"></textarea>

            <label style="margin-top:10px">Template Name:</label>
            <input type="text" id="template_name" placeholder="í…œí”Œë¦¿ ì´ë¦„" />
            
            <button type="button" onclick="addStepSetting()" style="background:#17a2b8; margin-top:5px;">+ ë‹¨ê³„(Step) ì¶”ê°€</button>
            <div id="stepSettingsContainer" style="margin-top:10px"></div>

            <hr style="margin: 20px 0;" />
            <button type="button" onclick="createTemplate()" style="background-color: #28a745; font-size: 1.1rem; padding: 12px;">í…œí”Œë¦¿ ì‹¤í–‰ (Create)</button>
        </form>

        <div class="iframe-panel">
            <div id="iframeActionContainer">
                <div id="actionControlArea">
                    <div class="switch-wrapper">
                        <span style="font-size:0.9rem; color:#555; margin-right: 10px; font-weight:bold;">Action ë²„íŠ¼ ì œì–´</span>
                        <label class="switch">
                            <input type="checkbox" id="toggleActionSwitch" />
                            <span class="slider"></span>
                        </label>
                    </div>
                    <div id="buttonList"></div>
                </div>
            </div>

            <div style="padding: 10px; background: #fff; border-bottom: 1px solid #ddd; margin-bottom: 10px; border-radius: 8px; margin-top: 10px;">
                <strong>ë¬¸ì„œ ì˜ì—­ (Iframe Mode)</strong>
            </div>
            <iframe id="eformsign_iframe" name="eformsign_iframe"></iframe>
        </div>
    </div>
    
    <script>
        var eformsign;
        var execution_time = Date.now() + "";

        // ì´ˆê¸°í™” ë° ì´ë²¤íŠ¸ ë°”ì¸ë”©
        $(function(){
            eformsign = new EformSignTemplate();
            eformsign.setDomain("https://www.gov-eformsign.com"); // CSAP ë„ë©”ì¸

            // 1. Action ë²„íŠ¼ 22ê°œ ë™ì  ìƒì„±
            var btnHtml = '';
            for(var i=1; i<=22; i++){
                var code = (i<10?'0':'')+i;
                btnHtml += '<button id="btn_'+code+'" onclick="actionTest(\''+code+'\')">Btn '+code+'</button> ';
            }
            $('#buttonList').html(btnHtml);

            // 2. ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ë“¤
            $('#mode_type').change(function(){
                var v = $(this).val();
                $('#template_id_section')[ (v==='02'||v==='03'||v==='04')? 'show':'hide' ]();
            });

            $('#tokenMethodSelect').change(function(){
                if(this.value==='signature') $('#privateKeyHex').attr('placeholder','Secret Key (Hex)');
                else $('#privateKeyHex').attr('placeholder','Bearer Token');
            });

            $('#getTokenButton').click(function(){ getAccessToken(); });

            // Action ìŠ¤ìœ„ì¹˜ ë³€ê²½ ì‹œ í‘œì‹œ/ìˆ¨ê¹€
            $('#toggleActionSwitch').change(function(){
                if(this.checked) $('#buttonList').css('display','flex');
                else $('#buttonList').hide();
            });
        });

        // Modal ë‹«ê¸°
        function closeModal() {
            $('#modalWrapper').fadeOut(200);
            // ëª¨ë‹¬ ë‹«ì„ ë•Œ, Action ë²„íŠ¼ ì˜ì—­ì„ ë‹¤ì‹œ ì›ë˜ ìœ„ì¹˜ë¡œ ë³µê·€
            $('#iframeActionContainer').append($('#actionControlArea'));
        }

        // Action ì‹¤í–‰ í•¨ìˆ˜
        function actionTest(code) {
            console.log("Send Action Code: " + code);
            eformsign.sendAction({ type: '02', code: code });
        }

        // í† í° ë°œê¸‰ (CSAP API)
        function getAccessToken(cb){
            var method = $('#tokenMethodSelect').val();
            execution_time = Date.now() + "";
            var apiKey = $('#apiKey').val();
            var user_id = $('#user_id').val();
            // [ì¤‘ìš”] CSAP API URL
            var url = 'https://www.gov-eformsign.com/Service/v2.0/api_auth/access_token';
            var sig;

            if(!apiKey || !user_id){ alert('User IDì™€ API Keyë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.'); return; }

            if(method==='signature'){
                try {
                    var pk = KEYUTIL.getKeyFromPlainPrivatePKCS8Hex($('#privateKeyHex').val());
                    var s = new KJUR.crypto.Signature({ alg: 'SHA256withECDSA' });
                    s.init(pk); s.updateString(execution_time);
                    sig = s.sign();
                } catch(e) { alert('Key í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.'); return; }
            } else {
                sig = 'Bearer ' + $('#privateKeyHex').val();
            }

            $.ajax({
                url: url, type: 'POST', contentType: 'application/json',
                data: JSON.stringify({ execution_time: parseInt(execution_time), member_id: user_id }),
                beforeSend: function(req){
                    req.setRequestHeader('eformsign_signature', sig);
                    req.setRequestHeader('Authorization', 'Bearer ' + btoa(apiKey));
                },
                success: function(data){
                    $('#access_token').val(data.oauth_token.access_token);
                    $('#refresh_token').val(data.oauth_token.refresh_token);
                    $('#company_id').val(data.api_key.company.company_id);
                    if(!cb) alert('í† í° ë°œê¸‰ ì™„ë£Œ!');
                    if(cb) cb(data.oauth_token.access_token, data.oauth_token.refresh_token, data.api_key.company.company_id);
                },
                error: function(xhr){ 
                    try {
                        var err = JSON.parse(xhr.responseText);
                        alert('ë°œê¸‰ ì‹¤íŒ¨:\n' + err.ErrorMessage);
                    } catch {
                        alert('í† í° ë°œê¸‰ ì‹¤íŒ¨: ' + xhr.responseText); 
                    }
                }
            });
        }

        // í…œí”Œë¦¿ ìƒì„± (í•µì‹¬ ë¡œì§)
        function createTemplate(){
            // 1. í‘œì‹œ ë°©ì‹ í™•ì¸
            const displayMode = $('input[name="display_mode"]:checked').val();
            let targetIframeId = 'eformsign_iframe'; // ê¸°ë³¸

            // 2. Action ì œì–´ ì˜ì—­ ì´ë™ (ìƒë‹¨ ë°°ì¹˜)
            if(displayMode === 'modal'){
                // ëª¨ë‹¬ ëª¨ë“œ -> ëª¨ë‹¬ ìƒë‹¨ ì»¨í…Œì´ë„ˆ(#modalActionContainer)ë¡œ ì´ë™
                $('#modalActionContainer').append($('#actionControlArea'));
                $('#modalWrapper').css('display', 'flex');
                targetIframeId = 'eformsign_modal_iframe';
            } else {
                // Iframe ëª¨ë“œ -> ìš°ì¸¡ íŒ¨ë„ ìƒë‹¨ìœ¼ë¡œ ì´ë™
                $('#iframeActionContainer').append($('#actionControlArea'));
                targetIframeId = 'eformsign_iframe';
            }

            getAccessToken(function(at, rt, cid){
                const modeType = $('#mode_type').val();
                const templateType = $('#templateTypeSelect').val();
                const steps = [];
                
                // Step Data ìˆ˜ì§‘
                $('#stepSettingsContainer .step-setting').each(function(){
                    const st=$(this);
                    const rec=[];
                    if(st.find('input[name="specify_recipients[]"]').is(':checked')){
                        st.find('.recipient-entry').each(function(){
                            const rId = $(this).find('input[name="recipient_id[]"]').val();
                            const rNm = $(this).find('input[name="recipient_name[]"]').val();
                            const rSms = $(this).find('input[name="recipient_sms[]"]').val();
                            if(rId) {
                                let ro = { id: rId, name: rNm };
                                if(rSms) ro.sms = rSms;
                                rec.push(ro);
                            }
                        });
                    }
                    let stepObj = {
                        step_type: st.find('input[type=radio]:checked').val(),
                        step_name: st.find('input[name="step_name[]"]').val()
                    };
                    if(templateType === 'unstructured_form'){
                        if(rec.length > 0){
                            stepObj.recipient = {
                                id: rec[0].id, name: rec[0].name, sms: rec[0].sms,
                                use_mail: st.find('input[name="use_mail[]"]').is(':checked'),
                                use_sms: st.find('input[name="use_sms[]"]').is(':checked'),
                                use_alimtalk: st.find('input[name="use_alimtalk[]"]').is(':checked')
                            };
                        }
                    } else {
                        stepObj.use_mail = st.find('input[name="use_mail[]"]').is(':checked');
                        stepObj.use_sms = st.find('input[name="use_sms[]"]').is(':checked');
                        stepObj.use_alimtalk = st.find('input[name="use_alimtalk[]"]').is(':checked');
                        stepObj.recipients = rec;
                    }
                    steps.push(stepObj);
                });

                const opts = {
                    company: { id: cid, country_code: $('#company_country_code').val() },
                    user: { id: $('#user_id').val(), access_token: at, refresh_token: rt },
                    mode: { type: modeType, template_type: templateType, template_id: $('#template_id').val()||'' },
                    layout: { lang_code: 'ko', header: true, footer: true },
                    prefill: { template_name: $('#template_name').val(), step_settings: steps },
                    template_file: { 
                        mime: 'application/octet-stream', 
                        name: $('#template_file_name').val(), 
                        data: $('#template_file_data').val() 
                    }
                };
                
                // [ë¡œê·¸ ì¶”ê°€] ì„œë²„ë¡œ ì „ì†¡ë˜ëŠ” Options ê°ì²´ ë¡œê·¸ ì¶œë ¥
                console.log("ğŸš€ [eformsign.template Request Options]", JSON.stringify(opts, null, 4));

                // 3. eformsign.template í˜¸ì¶œ
                eformsign.template(opts, targetIframeId, 
                    res => {
                        console.log("âœ… Success Callback:", JSON.stringify(res, null, 4));
                        if(res.template_id) alert("ì„±ê³µ (Template ID): " + res.template_id);
                        else if(res.document_id) alert("ì„±ê³µ (Document ID): " + res.document_id);
                    },
                    err => {
                        alert("ì˜¤ë¥˜: " + err.message);
                        if(displayMode === 'modal') closeModal();
                    },
                    actions => {
                        // Action ë²„íŠ¼ ì—…ë°ì´íŠ¸ ë¡œì§
                        console.log("Actions Received:", actions);
                        $('#buttonList button').hide();
                        const arr = Array.isArray(actions.data) ? actions.data : [actions.data];
                        arr.forEach(a => {
                            $('#btn_'+a.code).text(a.name).attr('title',a.name).show();
                        });
                        
                        // ìŠ¤ìœ„ì¹˜ ìƒíƒœì— ë”°ë¼ í‘œì‹œ ì—¬ë¶€ ê²°ì •
                        if($('#toggleActionSwitch').is(':checked')) {
                            $('#buttonList').css('display','flex');
                        } else {
                            $('#buttonList').hide();
                        }
                    }
                );

                // 4. ë¬¸ì„œ ì—´ê¸°
                eformsign.open();
            });
        }

        function handleFileSelect(e){
            const f = e.target.files[0];
            if(!f) return;
            const r = new FileReader();
            r.onload = ev => {
                $('#template_file_data').val(ev.target.result.split(',')[1]);
                $('#template_file_name').val(f.name);
            };
            r.readAsDataURL(f);
        }

        function addStepSetting(){
            const id = Date.now();
            const html = `
                <div class="step-setting" style="border:1px solid #ddd; padding:10px; margin-bottom:5px; background:#f9f9f9; border-radius:4px;">
                    <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
                        <label>Step Name:</label>
                        <button type="button" onclick="$(this).closest('.step-setting').remove()" style="width:auto; padding:2px 8px; background:#dc3545;">ì‚­ì œ</button>
                    </div>
                    <input type="text" name="step_name[]" value="Step ${id}" />
                    <div class="radio-group">
                        <label><input type="radio" name="step_type_${id}" value="05" checked>ì°¸ì—¬ì</label>
                        <label><input type="radio" name="step_type_${id}" value="06">ê²€í† ì</label>
                    </div>
                    <div class="notification-group">
                        <label><input type="checkbox" name="use_mail[]">Mail</label>
                        <label><input type="checkbox" name="use_sms[]">SMS</label>
                        <label><input type="checkbox" name="use_alimtalk[]">ì•Œë¦¼í†¡</label>
                    </div>
                    <label><input type="checkbox" name="specify_recipients[]" onclick="$(this).parent().next().toggle()"> ìˆ˜ì‹ ì ì§€ì •</label>
                    <div class="recipient-fields" style="display:none; margin-top:5px; padding-left:10px; border-left:2px solid #ccc;">
                        <button type="button" onclick="addRecipient(this)" style="width:auto; font-size:0.8rem; background:#6c757d; margin-bottom:5px;">+ ì¶”ê°€</button>
                    </div>
                </div>
            `;
            $('#stepSettingsContainer').append(html);
        }

        function addRecipient(btn){
            const html = `
                <div class="recipient-entry" style="border-bottom:1px dashed #ddd; padding-bottom:5px; margin-bottom:5px;">
                    <input type="text" name="recipient_id[]" placeholder="Email" style="margin-bottom:2px;" />
                    <input type="text" name="recipient_name[]" placeholder="ì´ë¦„" style="margin-bottom:2px;" />
                    <input type="text" name="recipient_sms[]" placeholder="ì „í™”ë²ˆí˜¸" style="margin-bottom:2px;" />
                    <button type="button" onclick="$(this).parent().remove()" style="width:auto; background:#dc3545; font-size:0.7rem;">ì‚­ì œ</button>
                </div>
            `;
            $(btn).parent().append(html);
        }
    </script>
</body>
</html>