<!DOCTYPE html>
<html>

<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<meta http-equiv="X-UA-Compatible" content="IE=edge" />
	<title>템플릿 관리</title>

	<script src="https://www.eformsign.com/plugins/jquery/jquery.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/jsrsasign/8.0.20/jsrsasign-all-min.js"></script>
	<script src="https://www.eformsign.com/lib/js/efs_embedded_form.js"></script>

	<style>
		body {
			width: 100%;
			margin: 0;
			font-family: Arial, sans-serif;
			background-color: #e9ecef;
			color: #333;
			display: flex;
			justify-content: center;
		}

		.container {
			display: flex;
			width: 90%;
			margin-top: 20px;
		}

		#templateForm {
			flex: 1;
			max-width: 50%;
			margin-right: 20px;
			background-color: #ffffff;
			border: 1px solid #ced4da;
			border-radius: 8px;
			padding: 20px;
			box-shadow: 0px 0px 12px rgba(0, 0, 0, 0.1);
		}

		h2 {
			text-align: center;
			color: #2a6592;
			font-size: 1.8rem;
		}

		h3 {
			color: #333;
			border-bottom: 1px solid #ddd;
			padding-bottom: 5px;
			margin-top: 20px;
			font-size: 1.2rem;
		}

		label {
			display: block;
			margin-bottom: 5px;
			font-weight: bold;
			color: #495057;
		}

		input[type="text"],
		textarea,
		select {
			width: 100%;
			padding: 12px;
			margin-bottom: 15px;
			border: 1px solid #ced4da;
			border-radius: 4px;
			font-size: 1rem;
			box-sizing: border-box;
			transition: border-color 0.3s;
		}

		input[type="text"]:focus,
		textarea:focus,
		select:focus {
			border-color: #86b7fe;
			outline: none;
		}

		button {
			background-color: #2a6592;
			color: white;
			padding: 10px 20px;
			border: none;
			border-radius: 4px;
			cursor: pointer;
			font-size: 1rem;
			transition: background-color 0.3s;
		}

		button:hover {
			background-color: #21507a;
		}

		#eformsign_iframe {
			flex: 1;
			width: 100%;
			height: 100vh;
			border: 1px solid #ced4da;
			border-radius: 8px;
			box-shadow: 0px 0px 12px rgba(0, 0, 0, 0.1);
		}

		.recipients-container {
			border: 1px solid #ddd;
			padding: 10px;
			margin-top: 10px;
			border-radius: 5px;
			background-color: #f9f9f9;
		}
	</style>

	<script type="text/javascript">
		var eformsign;
		var execution_time = Date.now() + "";
		var signature, apiKey;
		var ServiceUrl = 'https://api.eformsign.com'; // Default Service URL

		$(document).ready(function () {
			eformsign = new EformSignTemplate();
			eformsign.setDomain("https://www.eformsign.com");
			// 서버 환경 선택 시 URL 및 도메인 설정 변경
			$("#server_type").change(function () {
				var serverType = $(this).val();
				$("#custom_server_section").toggle(serverType === "custom"); // 사용자 지정 서버일 때만 보이도록
				switch (serverType) {
					case "test":
						ServiceUrl = 'https://test-kr-api.eformsign.com';
						eformsign.setDomain("https://test.eformsign.com");
						break;
					case "public":
						ServiceUrl = 'https://www.gov-eformsign.com/Service';
						eformsign.setDomain("https://www.gov-eformsign.com");
						break;
					case "custom":
						$("#custom_server_section").show();
						break;
					default:
						ServiceUrl = 'https://kr-api.eformsign.com';
						eformsign.setDomain("https://www.eformsign.com");
						break;
				}
			});
			// 사용자 지정 서버 URL 설정
			$("#customServiceUrl, #customDomainUrl").on("input", function () {
				if ($("#server_type").val() === "custom") {
					ServiceUrl = $("#customServiceUrl").val();
					eformsign.setDomain($("#customDomainUrl").val());
				}
			});

			// Mode type 변경 시 template_id 입력 필드를 보이거나 숨김
			$("#mode_type").change(function () {
				var modeType = $(this).val();
				if (modeType === "02" || modeType === "03" || modeType === "04") {
					$("#template_id_section").show();
				} else {
					$("#template_id_section").hide();
				}
			});

			// Prefill 옵션 표시
			$("#togglePrefill").click(function () {
				$("#prefill_section").toggle();
			});
		});

		function getAccessToken(callback) {
			var execution_time = Date.now() + "";
			var privateKeyHex = $('#privateKeyHex').val();
			var user_id = $('#user_id').val();
			apiKey = $('#apiKey').val();

			var privateKey = KEYUTIL.getKeyFromPlainPrivatePKCS8Hex(privateKeyHex);
			var s_sig = new KJUR.crypto.Signature({ alg: 'SHA256withECDSA' });
			s_sig.init(privateKey);
			s_sig.updateString(execution_time);
			signature = s_sig.sign();
			console.log('signature: ' + signature);

			var requestURL = ServiceUrl + '/v2.0/api_auth/access_token';
			var requestBody = {
				execution_time: execution_time,
				member_id: user_id
			};

			$.ajax({
				url: requestURL,
				type: 'POST',
				contentType: 'application/json; charset=UTF-8',
				accept: "application/json",
				data: JSON.stringify(requestBody),
				async: true,
				dataType: 'JSON',
				beforeSend: function (request) {
					request.setRequestHeader('eformsign_signature', signature);
					request.setRequestHeader('Authorization', 'Bearer ' + btoa(apiKey));
				},
				success: function (data) {
					var access_token = data.oauth_token.access_token;
					var refresh_token = data.oauth_token.refresh_token;
					var company_id = data.api_key.company.company_id;
					console.log(JSON.stringify(data));

					$("#access_token").val(access_token).prop("readonly", true);
					$("#refresh_token").val(refresh_token).prop("readonly", true);
					$("#company_id").val(company_id).prop("readonly", true);

					if (callback) callback(access_token, refresh_token, company_id);
				},
				error: function (xhr) {
					try {
						var errorData = JSON.parse(xhr.responseText);
						alert(`Access Token 발급 실패\n코드: ${errorData.code}\nErrorMessage: ${errorData.ErrorMessage}`);
					} catch (e) {
						alert('Failed to get access token. Please check your inputs.');
					}
				}
			});
		}


		function addStepSetting() {
    var stepSettingTemplate = `
        <div class="step-setting" style="border: 1px solid #ddd; padding: 10px; margin-bottom: 10px; border-radius: 5px;">
            <label>Step Name:</label>
            <input type="text" name="step_name[]" required />

            <label>Step Type:</label>
            <div>
                <label>
                    <input type="radio" name="step_type_${Date.now()}" value="05" required /> 참여자
                </label>
                <label>
                    <input type="radio" name="step_type_${Date.now()}" value="06" required /> 검토자
                </label>
            </div>

            <label>Use Mail:</label>
            <input type="checkbox" name="use_mail[]" />
            <label>Use SMS:</label>
            <input type="checkbox" name="use_sms[]" />
            <label>Use Alimtalk:</label>
            <input type="checkbox" name="use_alimtalk[]" />

            <!-- 수신자 지정 옵션 추가 -->
            <label>수신자 지정(멤버):</label>
            <input type="checkbox" name="specify_recipients[]" onclick="toggleRecipients(this)" />

            <!-- 수신자 필드 컨테이너를 박스로 감싸기 -->
            <div class="recipients-container" style="display:none; border: 1px solid #ddd; padding: 10px; margin-top: 10px; border-radius: 5px; background-color: #f9f9f9;">
                <h4>수신자 정보</h4>
                <button type="button" onclick="addRecipientField(this)" style="margin-bottom: 10px;">Add Recipient</button>
                <div class="recipient-fields"></div>
            </div>
			<br>

            <!-- 수신자 설정 전체 삭제 버튼 위치 이동 -->
            <button type="button" onclick="removeStepSetting(this)" style="margin-top: 10px;">Remove Step</button>
        </div>
    `;
    $("#stepSettingsContainer").append(stepSettingTemplate);
}

		function toggleRecipients(checkbox) {
			var recipientsContainer = $(checkbox).siblings(".recipients-container");
			if (checkbox.checked) {
				recipientsContainer.show();
			} else {
				recipientsContainer.hide();
				recipientsContainer.find(".recipient-fields").empty();
			}
		}

		function addRecipientField(button) {
			var recipientFieldTemplate = `
            <div style="margin-top: 5px;">
                <label>Recipient ID:</label>
                <input type="text" name="recipient_id[]" placeholder="example@domain.com" />
                <button type="button" onclick="removeRecipientField(this)">Remove</button>
            </div>
        `;
			$(button).siblings(".recipient-fields").append(recipientFieldTemplate);
		}

		function removeRecipientField(button) {
			$(button).parent().remove();
		}

		function removeStepSetting(button) {
			$(button).parent().remove();
		}
		function createTemplate() {
			var execution_time = Date.now() + "";
			getAccessToken(function (access_token, refresh_token, company_id) {
				var stepSettings = [];
				$("#stepSettingsContainer .step-setting").each(function () {
					var stepType = $(this).find("input[type='radio']:checked").val();
					var recipients = [];

					// 수신자 지정이 체크된 경우 수신자 추가
					if ($(this).find("input[name='specify_recipients[]']").is(":checked")) {
						$(this).find(".recipient-fields input[name='recipient_id[]']").each(function () {
							recipients.push({ "id": $(this).val() });
						});
					}

					stepSettings.push({
						"step_type": stepType,
						"step_name": $(this).find("input[name='step_name[]']").val(),
						"use_mail": $(this).find("input[name='use_mail[]']").is(":checked"),
						"use_sms": $(this).find("input[name='use_sms[]']").is(":checked"),
						"use_alimtalk": $(this).find("input[name='use_alimtalk[]']").is(":checked"),
						"recipients": recipients
					});
				});

				// Template 생성 옵션
				var template_option = {
					"company": {
						"id": company_id,
						"country_code": $("#company_country_code").val() || "kr",
					},
					"user": {
						"id": $("#user_id").val(),
						"access_token": access_token,
						"refresh_token": refresh_token,
					},
					"mode": {
						"type": $("#mode_type").val(),
						"template_type": $("#template_type").val(),
						"template_id": $("#template_id").val() || ""
					},
					"layout": {
						"lang_code": "ko",
						"header": true,
						"footer": true,
					},
					"prefill": {
						"template_name": $("#template_name").val(),
						"step_settings": stepSettings
					},
					"template_file": {
						mime: "@file/octet-stream",
						"name": $("#template_file_name").val(),
						"data": $("#template_file_data").val()
					}
				};

				// 템플릿 생성 호출
				var success_callback = function (response) {
					alert("템플릿 생성에 성공하였습니다. template_id: " + response.template_id);
					console.log(response);
				};

				var error_callback = function (response) {
					alert("템플릿 생성에 실패하였습니다. 오류: " + response.message);
					console.error(response);
				};

				eformsign.template(
					template_option,
					"eformsign_iframe",
					success_callback,
					error_callback
				);

				eformsign.open();
			});
		}

		function handleFileSelect(event) {
			var file = event.target.files[0];
			if (file) {
				var reader = new FileReader();
				reader.onload = function (e) {
					var base64String = e.target.result.split(',')[1];
					$('#template_file_data').val(base64String);
					$('#template_file_name').val(file.name);
				};
				reader.readAsDataURL(file);
			}
		}
	</script>
</head>

<body>
	
	
	

	<div class="container">
		<form id="templateForm">
			<h2>템플릿 관리</h2>
			<h3>서버 환경 선택</h3>
			<label for="server_type">서버 타입:</label>
			<select id="server_type">
				<option value="production" selected>운영 서버</option>
				<option value="test">테스트 서버</option>
				<option value="public">공공 서버</option>
				<option value="custom">사용자 지정 서버</option>
			</select>
			<div id="custom_server_section" style="display:none; margin-top: 15px;">
				<label for="customServiceUrl">사용자 지정 Service URL:</label>
				<input type="text" id="customServiceUrl" placeholder="예: https://custom-api.eformsign.com" />

				<label for="customDomainUrl">사용자 지정 Domain URL:</label>
				<input type="text" id="customDomainUrl" placeholder="예: https://custom.eformsign.com" />
			</div>
			<h3>회사 정보</h3>
			<label>Company ID(Access token 발급 시 자동으로 생성):</label>
			<input type="text" id="company_id" readonly />
			<label>Country Code (기본값:kr):</label>
			<input type="text" id="company_country_code" placeholder="kr" />

			<h3>Access token 발급 정보</h3>
			<label>Private Key (Hex):</label>
			<input type="text" id="privateKeyHex" required />
			<label>API Key:</label>
			<input type="text" id="apiKey" required />
			<label>User ID:</label>
			<input type="text" id="user_id" required />
			<button type="button" onclick="getAccessToken()">토큰 발급</button>

			<h3>Access Token 정보</h3>
			<label>Access Token:</label>
			<input type="text" id="access_token" readonly />
			<label>Refresh Token:</label>
			<input type="text" id="refresh_token" readonly />

			<h3>Mode</h3>
			<label>Type(01:생성, 02:수정, 03:복제, 04:미리보기):</label>
			<input type="text" id="mode_type" placeholder="01" required />
			<label>Template Type:</label>
			<input type="text" id="template_type" placeholder="form" required />

			<div id="template_id_section">
				<h3>Template ID</h3>
				<label>Template ID:</label>
				<input type="text" id="template_id" placeholder="02(수정),03(복제),04(미리보기)시 Template id 입력" />
			</div>

			<h3>Template File(PDF파일만 가능)</h3>
			<label>File Name:</label>
			<input type="text" id="template_file_name" required />
			<label>Upload File:</label>
			<input type="file" id="fileUpload" onchange="handleFileSelect(event)" />
			<label>File Data (Base64):</label>
			<textarea id="template_file_data" rows="4"></textarea>

			<h3>Prefill 설정</h3>
			<button type="button" id="togglePrefill">Prefill 옵션 설정</button>

			<div id="prefill_section">
				<label>Template Name:</label>
				<input type="text" id="template_name" />

				<h3>Step Settings</h3>
				<button type="button" onclick="addStepSetting()">Add Step Setting</button>
				<div id="stepSettingsContainer" style="margin-top: 10px;"></div>
			</div>

			<button type="button" onclick="createTemplate()" style="margin-top: 20px;">Create Template</button>
		</form>

		<iframe id="eformsign_iframe" name="eformsign_iframe"></iframe>
	</div>
</body>

</html>