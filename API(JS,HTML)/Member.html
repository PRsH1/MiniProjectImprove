<!DOCTYPE html>
<html lang="ko">

<head>
  <meta charset="UTF-8" name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Access Token 발급 및 멤버 API</title>
  <style>
    body {
      font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
      background-color: #f4f4f4;
      margin: 0;
      padding: 0;
    }
    .container {
      max-width: 800px;
      margin: 30px auto;
      background: #fff;
      border: 1px solid #ddd;
      border-radius: 4px;
      padding: 20px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    h1,h2,h3 { margin-top: 0; }
    h2 { border-bottom: 1px solid #ddd; padding-bottom: 8px; }
    .form-group { margin-bottom: 15px; }
    label { display: block; font-weight: bold; margin-bottom: 5px; }
    input, select, button {
      width: 100%;
      padding: 8px;
      border: 1px solid #ccc;
      border-radius: 4px;
      box-sizing: border-box;
    }
    button { cursor: pointer; }
    .section { margin-bottom: 30px; }
    #urlDisplay, #tokenResult,
    #result, #deleteResult,
    #excelResult, #excelDeleteResult,
    #updateResult, #excelUpdateResult {
      margin-top: 15px;
      background: #f7f7f7;
      padding: 10px;
      border: 1px solid #ddd;
      white-space: pre-wrap;
      font-size: 0.9em;
      word-wrap: break-word;
      overflow-wrap: anywhere;
    }
    .toggle-btn, .nav-btn, .download-btn {
      background: #007bff;
      color: #fff;
      border: none;
      border-radius: 4px;
      padding: 10px;
      margin-bottom: 15px;
    }
    .nav-menu {
      margin-bottom: 20px;
      text-align: center;
    }
    .nav-menu button {
      width: auto;
      margin: 0 10px;
    }
    /* 숨김 처리 */
    #optionalFields,
    #excelUploadSection,
    #excelDeleteUploadSection,
    #excelUpdateUploadSection,
    #memberAddSection,
    #memberDeleteSection,
    #memberUpdateSection {
      display: none;
    }
    .secret-key-method { display: flex; flex-direction: column; margin-bottom: 15px; }
    .radio-group { display: flex; gap: 20px; align-items: center; }
    #tableContainer { overflow-x: auto; margin-top: 15px; }
    #listResultTable tr:nth-child(even) { background-color: #f9f9f9; }
    #listResultTable th {
      background-color: #007bff;
      color: #fff;
      position: sticky;
      top: 0;
      z-index: 1;
      padding: 8px;
    }
  </style>
</head>

<body>
  <div class="container">
    <h1>Access Token 발급 및 멤버 API</h1>
    <h3>제작: 이승현</h3>
    <h4>Note: 멤버 삭제 시 메일이 발송됩니다. (Postman상으로는 메일이 발송되지 않음)</h4>

    <!-- Access Token 발급 섹션 -->
    <div class="section" id="tokenSection">
      <h2>Access Token 발급</h2>
      <div class="form-group">
        <label for="envSelection">환경 선택:</label>
        <select id="envSelection">
          <option value="op_saas">운영 (SaaS)</option>
          <option value="csap">공공 (CSAP)</option>
          <option value="custom">사용자 지정 환경</option>
        </select>
      </div>
      <!-- custom URL 입력 -->
      <div class="form-group" id="customEnvUrlField" style="display:none;">
        <label for="customEnvUrl">사용자 지정 Base URL:</label>
        <input type="text" id="customEnvUrl" placeholder="예: https://eform.cbe.go.kr/Service">
      </div>
      <div id="urlDisplay"></div>
      <div class="form-group">
        <label for="apiKey">API-KEY:</label>
        <input type="text" id="apiKey" placeholder="API-KEY 입력">
      </div>
      <div class="form-group secret-key-method">
        <label>비밀 키 입력 방식:</label>
        <div class="radio-group">
          <label><input type="radio" name="secretKeyMethod" value="signature" checked> Signature 방식</label>
          <label><input type="radio" name="secretKeyMethod" value="bearer"> Bearer token 방식</label>
        </div>
      </div>
      <div class="form-group">
        <label id="secretKeyLabel" for="privateKeyHex">비밀 키 (Secret key, Hex):</label>
        <input type="text" id="privateKeyHex" placeholder="예: 30... (Signature 방식)">
      </div>
      <div class="form-group">
        <label for="user_id_token">User ID:</label>
        <input type="text" id="user_id_token" placeholder="User ID 입력">
      </div>
      <button onclick="getAccessToken()">Access Token 발급</button>
      <div class="form-group">
        <label for="accessToken">Access Token:</label>
        <input type="text" id="accessToken" readonly>
      </div>
      <div class="form-group">
        <label for="refreshToken">Refresh Token:</label>
        <input type="text" id="refreshToken" readonly>
      </div>
      <div class="form-group">
        <label for="companyId">Company ID:</label>
        <input type="text" id="companyId" readonly>
      </div>
      <div id="tokenResult"></div>
    </div>

    <!-- 상단 네비게이션 -->
    <div class="nav-menu">
      <button class="nav-btn" onclick="showSection('memberAddSection')">멤버 추가</button>
      <button class="nav-btn" onclick="showSection('memberDeleteSection')">멤버 삭제</button>
      <button class="nav-btn" onclick="showSection('memberUpdateSection')">멤버 수정</button>
      <button class="nav-btn" onclick="showSection('memberListSection')">구성원 목록 조회</button>
      <button class="nav-btn" onclick="showSection('groupAddSection')">그룹 추가</button>
    </div>

    <!-- 멤버 추가 -->
    <div class="section" id="memberAddSection">
      <h2>멤버 추가 API 호출</h2>
      <p>※ 위 Access Token 발급 후 자동으로 채워진 Access Token을 사용합니다.</p>
      <h3>수동 입력</h3>
      <div class="form-group">
        <label for="accountId">계정 이메일,ID:</label>
        <input type="text" id="accountId" placeholder="예: test98@forcs.com">
      </div>
      <div class="form-group">
        <label for="accountPassword">비밀번호:</label>
        <input type="password" id="accountPassword" placeholder="비밀번호 입력">
      </div>
      <div class="form-group">
        <label for="accountFirstName">사용자 이름:</label>
        <input type="text" id="accountFirstName" placeholder="예: test98">
      </div>
      <div class="form-group mail-option">
        <label>이메일 전송 옵션:</label>
        <div class="radio-group">
          <label><input type="radio" name="mailOption" value="true" checked> 가입 시 이메일 발송 (기본값)</label>
          <label><input type="radio" name="mailOption" value="false"> 이메일 발송 안 함</label>
        </div>
      </div>
      <button type="button" class="toggle-btn" id="toggleOptionalBtn">추가 옵션 보기</button>
      <div id="optionalFields">
        <h3>사용자 연락처 정보</h3>
        <div class="form-group">
          <label for="contactTel">전화번호:</label>
          <input type="text" id="contactTel" placeholder="예: 010-1234-5678">
        </div>
        <div class="form-group">
          <label for="contactNumber">휴대폰 번호:</label>
          <input type="text" id="contactNumber" placeholder="예: 010-2345-6789">
        </div>
        <div class="form-group">
          <label for="contactCountryNumber">국가 번호:</label>
          <input type="text" id="contactCountryNumber" placeholder="예: +82">
        </div>
        <div class="form-group">
          <label for="department">부서:</label>
          <input type="text" id="department" placeholder="예: 연구소">
        </div>
        <div class="form-group">
          <label for="position">직책:</label>
          <input type="text" id="position" placeholder="예: 연구원">
        </div>
        <div class="form-group">
          <label><input type="checkbox" id="agreementMarketing"> 마케팅 정보 수신 동의</label>
        </div>
        <div class="form-group">
          <label for="role">사용자 권한 정보 (콤마로 구분):</label>
          <input type="text" id="role" placeholder="예: company_manager, template_manager">
        </div>
        <div class="form-group">
          <label>external_sso_info:</label>
          <input type="text" id="externalUuid" placeholder="예: 123456789">
          <input type="text" id="externalAccountId" placeholder="예: pks2111@naver.com">
        </div>
      </div>
      <button onclick="addMember()">멤버 추가</button>

      <h3>엑셀 파일 업로드 (추가)</h3>
      <button type="button" class="toggle-btn" id="toggleExcelUploadBtn">엑셀 파일 업로드 보기</button>
      <div id="excelUploadSection">
        <p>엑셀 파일에는 아래와 같은 헤더가 필요합니다:</p>
        <p>id, password, first_name, contact_tel, contact_number, contact_country_number, department, position, agreement_marketing, role, external_uuid, external_account_id</p>
        <button type="button" class="download-btn" onclick="downloadTemplate()">템플릿 다운로드 (.xlsx)</button>
        <div class="form-group">
          <input type="file" id="excelFileInput" accept=".xlsx, .xls">
        </div>
        <button onclick="validateExcelFile()">엑셀 파일 검증</button>
        <div id="excelResult"></div>
        <div id="excelExecuteSection" style="display:none;">
          <button onclick="executeExcelMemberAddition()">멤버 추가 실행</button>
        </div>
      </div>

      <div id="result"></div>
    </div>

    <!-- 멤버 삭제 -->
    <div class="section" id="memberDeleteSection">
      <h2>멤버 삭제 API 호출</h2>
      <div class="form-group">
        <label for="deleteMemberId">삭제할 member_id:</label>
        <input type="text" id="deleteMemberId" placeholder="예: test98@forcs.com">
      </div>
      <div class="form-group mail-option-delete">
        <label>이메일 전송 옵션 (삭제):</label>
        <div class="radio-group">
          <label><input type="radio" name="mailOptionDelete" value="true" checked> 삭제 시 이메일 발송 (기본값)</label>
          <label><input type="radio" name="mailOptionDelete" value="false"> 삭제 시 이메일 발송 안 함</label>
        </div>
      </div>
      <button onclick="deleteMember()">멤버 삭제</button>
      <div id="deleteResult"></div>

      <h3>엑셀 파일 업로드 (삭제)</h3>
      <button type="button" class="toggle-btn" id="toggleExcelDeleteUploadBtn">엑셀 파일 업로드 보기 (삭제)</button>
      <div id="excelDeleteUploadSection" style="display:none;">
        <p>엑셀 파일에는 아래와 같은 헤더가 필요합니다 (id만 필요):</p>
        <p>id</p>
        <button type="button" class="download-btn" onclick="downloadDeleteTemplate()">템플릿 다운로드 (.xlsx)</button>
        <div class="form-group">
          <input type="file" id="excelFileDeleteInput" accept=".xlsx, .xls">
        </div>
        <button onclick="validateExcelFileForDeletion()">엑셀 파일 검증 (삭제)</button>
        <div id="excelDeleteResult"></div>
        <div id="excelDeleteExecuteSection" style="display:none;">
          <button onclick="executeExcelMemberDeletion()">멤버 삭제 실행</button>
        </div>
      </div>
    </div>

    <!-- 멤버 수정 -->
    <div class="section" id="memberUpdateSection">
      <h2>멤버 수정 API 호출</h2>
      <div class="form-group">
        <label for="updateMemberId">수정할 member_id:</label>
        <input type="text" id="updateMemberId" placeholder="예: test1@forcs.com">
      </div>
      <div class="form-group">
        <label for="updateAccountId">계정 이메일,ID (자동 복사):</label>
        <input type="text" id="updateAccountId" readonly>
      </div>
      <div class="form-group">
        <label for="updateName">사용자 이름:</label>
        <input type="text" id="updateName" placeholder="예: 홍길동">
      </div>
      <div class="form-group">
        <label for="updateEnabled">account.enabled:</label>
        <select id="updateEnabled">
          <option value="true">true</option>
          <option value="false">false</option>
        </select>
      </div>
      <div class="form-group">
        <label for="updateContactNumber">휴대폰 번호:</label>
        <input type="text" id="updateContactNumber" placeholder="예: 010-2345-6789">
      </div>
      <div class="form-group">
        <label for="updateContactTel">전화번호:</label>
        <input type="text" id="updateContactTel" placeholder="예: 010-1234-5678">
      </div>
      <div class="form-group">
        <label for="updateDepartment">부서:</label>
        <input type="text" id="updateDepartment" placeholder="예: 연구소">
      </div>
      <div class="form-group">
        <label for="updatePosition">직책:</label>
        <input type="text" id="updatePosition" placeholder="예: 연구원">
      </div>
      <div class="form-group">
        <label for="updateRole">사용자 권한 정보 (콤마로 구분):</label>
        <input type="text" id="updateRole" placeholder="예: company_manager, template_manager">
      </div>
      <button onclick="updateMember()">멤버 수정</button>

      <h3>엑셀 파일 업로드 (수정)</h3>
      <button type="button" class="toggle-btn" id="toggleExcelUpdateUploadBtn">엑셀 파일 업로드 보기 (수정)</button>
      <div id="excelUpdateUploadSection" style="display:none;">
        <p>엑셀 파일에는 아래와 같은 헤더가 필요합니다:</p>
        <p>id, name, enabled, contact_number, contact_tel, department, position, role</p>
        <button type="button" class="download-btn" onclick="downloadUpdateTemplate()">템플릿 다운로드 (.xlsx)</button>
        <div class="form-group">
          <input type="file" id="excelFileUpdateInput" accept=".xlsx, .xls">
        </div>
        <button onclick="validateExcelFileForUpdate()">엑셀 파일 검증 (수정)</button>
        <div id="excelUpdateResult"></div>
        <div id="excelUpdateExecuteSection" style="display:none;">
          <button onclick="executeExcelMemberUpdate()">멤버 수정 실행</button>
        </div>
      </div>
      <div id="updateResult"></div>
    </div>

    <!-- 구성원 목록 조회 -->
    <div class="section" id="memberListSection" style="display:none;">
      <h2>구성원 목록 조회</h2>
      <div class="nav-menu">
        <button class="nav-btn" onclick="listMembers('json')">JSON 형식으로 보기</button>
        <button class="nav-btn" onclick="listMembers('table')">표 형식으로 보기</button>
      </div>
      <div id="jsonContainer" style="display:none;">
        <pre id="listResultJson"></pre>
      </div>
      <div id="tableContainer" style="display:none;">
        <table id="listResultTable" style="width:100%; border-collapse:collapse;">
          <thead>
            <tr>
              <th>id</th><th>이름</th><th>부서</th><th>직책</th><th>생성일</th><th>enabled</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
    <div class="section" id="groupAddSection" style="display:none;">
      <h2>그룹 추가 API 호출</h2>
      <p>※ 위 Access Token 발급 후 사용합니다.</p>

      <!-- 수동 입력 -->
      <h3>수동 입력</h3>
      <div class="form-group">
        <label for="groupName">그룹 이름:</label>
        <input type="text" id="groupName" placeholder="예: 테스트그룹">
      </div>
      <div class="form-group">
        <label for="groupDescription">그룹 설명:</label>
        <input type="text" id="groupDescription" placeholder="예: 클라우드팀">
      </div>
      <div class="form-group">
        <label for="groupMembers">그룹 멤버 ID 리스트 (콤마 구분):</label>
        <input type="text" id="groupMembers" placeholder="예: user1@forcs.com,user2@forcs.com">
      </div>
        <button onclick="addGroup()">그룹 추가</button>
      <pre id="groupResult" style="background:#f7f7f7; padding:10px; border:1px solid #ddd;"></pre>

      <!-- 엑셀 업로드 -->
      <h3>엑셀 파일 업로드(그룹 추가)</h3>
      <button type="button" class="toggle-btn" id="toggleGroupExcelBtn">엑셀 파일 업로드 보기 (그룹 추가)</button>
      <div id="excelGroupUploadSection" style="display:none;">
        <p>엑셀 파일 헤더: <strong>name, description, members</strong></p>
        <button class="download-btn" onclick="downloadGroupTemplate()">템플릿 다운로드 (.xlsx)</button>
        <div class="form-group">
          <input type="file" id="excelGroupFileInput" accept=".xlsx, .xls">
        </div>
        <button onclick="validateExcelGroupFile()">엑셀 검증</button>
        <pre id="excelGroupResult" style="background:#f7f7f7; padding:10px; border:1px solid #ddd;"></pre>
        <div id="excelGroupExecuteSection" style="display:none;">
          <button onclick="executeExcelGroupAddition()">실행</button>
        </div>
      </div>
    </div>
    <!-- ★ 그룹 추가 섹션 끝 ★ -->
  </div>

  <!-- 라이브러리 로드 -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jsrsasign/10.5.25/jsrsasign-all-min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

  <script>
    // 고정 URL 매핑
    const tokenUrlMap = {
      "op_saas": "https://kr-api.eformsign.com/v2.0/api_auth/access_token",
      "csap":    "https://www.gov-eformsign.com/Service/v2.0/api_auth/access_token"
    };
    const memberUrlMap = {
      "op_saas": "https://kr-api.eformsign.com/v2.0/api/members",
      "csap":    "https://www.gov-eformsign.com/Service/v2.0/api/members"
    };

    // 섹션 토글
    function showSection(id) {
      ['memberAddSection','memberDeleteSection','memberUpdateSection','memberListSection','groupAddSection']
        .forEach(sec => document.getElementById(sec).style.display = 'none');
      document.getElementById(id).style.display = 'block';
    }

    // URL 표시 및 custom 필드
    function updateUrlDisplay() {
      const env = $('#envSelection').val();
      let tokenUrl, memberUrl;
      if (env === 'custom') {
        const base = $('#customEnvUrl').val().trim().replace(/\/$/, '');
        tokenUrl  = base ? `${base}/v2.0/api_auth/access_token` : '(Base URL 입력 필요)';
        memberUrl = base ? `${base}/v2.0/api/members`            : '(Base URL 입력 필요)';
      } else {
        tokenUrl  = tokenUrlMap[env];
        memberUrl = memberUrlMap[env];
      }
      $('#urlDisplay').html(`Access Token URL: ${tokenUrl}<br>멤버 API URL: ${memberUrl}`);
    }

    $(document).ready(function() {
      // 초기 세팅
      updateUrlDisplay();
      // 환경 선택 변경
      $('#envSelection').on('change', function(){
        if (this.value==='custom') $('#customEnvUrlField').slideDown();
        else $('#customEnvUrlField').slideUp();
        updateUrlDisplay();
      });
      $('#customEnvUrl').on('input', updateUrlDisplay);
      // secretKey 방식 토글
      $('input[name="secretKeyMethod"]').change(function(){
        if (this.value==='signature') {
          $('#secretKeyLabel').text('비밀 키 (Secret key, Hex):');
          $('#privateKeyHex').attr('placeholder','예: 30... (Signature 방식)');
        } else {
          $('#secretKeyLabel').text('비밀 토큰:');
          $('#privateKeyHex').attr('placeholder','예: test (Bearer token 방식)');
        }
      });
      // 옵션 토글
      $('#toggleOptionalBtn').click(function(){
        $('#optionalFields').slideToggle();
        $(this).text($(this).text()==='추가 옵션 보기'?'추가 옵션 숨기기':'추가 옵션 보기');
      });
      $('#toggleExcelUploadBtn').click(function(){
        $('#excelUploadSection').slideToggle();
        $(this).text($(this).text()==='엑셀 파일 업로드 보기'?'엑셀 파일 업로드 숨기기':'엑셀 파일 업로드 보기');
      });
      $('#toggleExcelDeleteUploadBtn').click(function(){
        $('#excelDeleteUploadSection').slideToggle();
        $(this).text($(this).text()==='엑셀 파일 업로드 보기 (삭제)'?'엑셀 파일 업로드 숨기기 (삭제)':'엑셀 파일 업로드 보기 (삭제)');
      });
      $('#toggleExcelUpdateUploadBtn').click(function(){
        $('#excelUpdateUploadSection').slideToggle();
        $(this).text($(this).text()==='엑셀 파일 업로드 보기 (수정)'?'엑셀 파일 업로드 숨기기 (수정)':'엑셀 파일 업로드 보기 (수정)');
      });
      // updateMemberId 자동 복사
      $('#updateMemberId').on('change', () => {
        $('#updateAccountId').val($('#updateMemberId').val().trim());
      });
      $('#toggleGroupExcelBtn').click(function() {
      $('#excelGroupUploadSection').slideToggle();
      const showing = $('#excelGroupUploadSection').is(':visible');
      $(this).text(showing ? '엑셀 업로드 숨기기' : '엑셀 업로드 보기');
  });
      // 기본 영역
      showSection('memberAddSection');
    });

    // === Access Token 발급 ===
    function getAccessToken() {
      const env = $('#envSelection').val();
      let requestURL;
      if (env==='custom') {
        const base = $('#customEnvUrl').val().trim().replace(/\/$/, '');
        if (!base) return alert('사용자 지정 Base URL을 입력하세요.');
        requestURL = `${base}/v2.0/api_auth/access_token`;
      } else {
        requestURL = tokenUrlMap[env];
      }

      const execution_time = Date.now() + '';
      const privateKeyInput = $('#privateKeyHex').val().trim();
      const user_id = $('#user_id_token').val().trim();
      const apiKey = $('#apiKey').val().trim();
      if (!privateKeyInput||!user_id||!apiKey)
        return alert('API-KEY, 비밀 키/토큰, User ID 모두 입력해주세요.');

      let signatureValue = '';
      const method = $('input[name="secretKeyMethod"]:checked').val();
      if (method==='signature') {
        try {
          const privateKey = KEYUTIL.getKeyFromPlainPrivatePKCS8Hex(privateKeyInput);
          const s_sig = new KJUR.crypto.Signature({ alg:'SHA256withECDSA' });
          s_sig.init(privateKey);
          s_sig.updateString(execution_time);
          signatureValue = s_sig.sign();
        } catch(e) {
          return alert('서명 생성 중 오류: '+e);
        }
      } else {
        signatureValue = 'Bearer '+privateKeyInput;
      }

      const requestBody = { execution_time: parseInt(execution_time), member_id: user_id };
      $('#tokenResult').html('Access Token 발급 요청 중...');

      $.ajax({
        url: requestURL,
        type: 'POST',
        contentType: 'application/json; charset=UTF-8',
        data: JSON.stringify(requestBody),
        beforeSend: req => {
          req.setRequestHeader('Authorization','Bearer '+btoa(apiKey));
          req.setRequestHeader('eformsign_signature', signatureValue);
        },
        success: data => {
          $('#accessToken').val(data.oauth_token.access_token);
          $('#refreshToken').val(data.oauth_token.refresh_token);
          $('#companyId').val(data.api_key.company.company_id);
          $('#tokenResult').html('Access Token 발급 성공.\n'+JSON.stringify(data,null,2));
        },
        error: (jqXHR, textStatus, errorThrown) => {
          let resp;
          try { resp = JSON.parse(jqXHR.responseText); }
          catch { resp = { message:'파싱 오류' }; }
          const code = resp.code||jqXHR.status||'Unknown';
          const msg = resp.ErrorMessage||errorThrown;
          alert(`발급 실패:\n코드: ${code}\n메시지: ${msg}`);
          $('#tokenResult').html(`Access Token 발급 실패.\n코드: ${code}\n응답:\n${JSON.stringify(resp,null,2)}`);
        }
      });
    }

    // === 멤버 추가 ===
    function addMember() {
      const token = $('#accessToken').val().trim();
      if (!token) return alert('먼저 Access Token 발급해주세요.');

      const id = $('#accountId').val().trim();
      const pw = $('#accountPassword').val().trim();
      const fn = $('#accountFirstName').val().trim();
      if (!id||!pw||!fn) return alert('id, password, first_name은 필수 입력입니다.');

      let account = { id, password: pw, first_name: fn };
      // 연락처
      const tel = $('#contactTel').val().trim();
      const num = $('#contactNumber').val().trim();
      const ccn = $('#contactCountryNumber').val().trim();
      let contact = {};
      if (tel) contact.tel = tel;
      if (num) contact.number = num;
      if (ccn) contact.country_number = ccn;
      if (Object.keys(contact).length) account.contact = contact;
      // 부서/직책
      const dept = $('#department').val().trim(); if (dept) account.department = dept;
      const pos  = $('#position').val().trim();   if (pos) account.position   = pos;
      // 마케팅 동의
      if ($('#agreementMarketing').is(':checked')) account.agreement = { marketing: true };
      // 권한
      const roles = $('#role').val().trim();
      if (roles) account.role = roles.split(',').map(r=>r.trim()).filter(r=>r);
      // external_sso_info
      let external = {};
      const extUuid = $('#externalUuid').val().trim();
      const extAcc  = $('#externalAccountId').val().trim();
      if (extUuid) external.uuid = extUuid;
      if (extAcc)  external.account_id = extAcc;
      if (Object.keys(external).length) account.external_sso_info = external;

      const requestBody = { account };
      const env = $('#envSelection').val();
      let baseUrl;
      if (env==='custom') {
        const b = $('#customEnvUrl').val().trim().replace(/\/$/, '');
        if (!b) return alert('사용자 지정 Base URL을 입력하세요.');
        baseUrl = `${b}/v2.0/api/members`;
      } else {
        baseUrl = memberUrlMap[env];
      }
      let url = baseUrl;
      if ($('input[name="mailOption"]:checked').val()==='false') url += '?mailOption=false';

      $('#result').html(`실행 URL: ${url}\n멤버 추가 중...`);
      fetch(url, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': 'Bearer '+token
        },
        body: JSON.stringify(requestBody)
      })
      .then(res => {
        if (!res.ok) return res.text().then(t=>{throw new Error(`${res.status}: ${t}`)});
        return res.json();
      })
      .then(data => {
        $('#result').html('멤버 추가 성공.\n'+JSON.stringify(data,null,2));
      })
      .catch(err => {
        $('#result').html('Error: '+err);
      });
    }

    // === 멤버 삭제 ===
    function deleteMember() {
      const token = $('#accessToken').val().trim();
      if (!token) return alert('먼저 Access Token 발급해주세요.');

      const memberId = $('#deleteMemberId').val().trim();
      if (!memberId) return alert('삭제할 member_id를 입력해주세요.');

      const env = $('#envSelection').val();
      let baseUrl;
      if (env==='custom') {
        const b = $('#customEnvUrl').val().trim().replace(/\/$/, '');
        if (!b) return alert('사용자 지정 Base URL을 입력하세요.');
        baseUrl = `${b}/v2.0/api/members`;
      } else {
        baseUrl = memberUrlMap[env];
      }
      let url = `${baseUrl}/${encodeURIComponent(memberId)}`;
      if ($('input[name="mailOptionDelete"]:checked').val()==='false') url += '?mailOption=false';

      $('#deleteResult').html(`실행 URL: ${url}\n삭제 중...`);
      fetch(url, {
        method: 'DELETE',
        headers: {
          'Accept': '*/*',
          'Content-Type': 'application/json',
          'Authorization': 'Bearer '+token
        },
        body: JSON.stringify({})
      })
      .then(res => {
        if (!res.ok) return res.text().then(t=>{throw new Error(`${res.status}: ${t}`)});
        return res.text().then(t => t?JSON.parse(t):{});
      })
      .then(data => {
        $('#deleteResult').html('삭제 성공.\n'+JSON.stringify(data,null,2));
      })
      .catch(err => {
        $('#deleteResult').html('Error: '+err);
      });
    }

    // === 멤버 수정 ===
    function updateMember() {
      const token = $('#accessToken').val().trim();
      if (!token) return alert('먼저 Access Token 발급해주세요.');

      const memberId = $('#updateMemberId').val().trim();
      if (!memberId) return alert('수정할 member_id를 입력해주세요.');

      let account = { id: memberId };
      const name = $('#updateName').val().trim(); if (name) account.name = name;
      account.enabled = ($('#updateEnabled').val()==='true');
      const num = $('#updateContactNumber').val().trim();
      const tel = $('#updateContactTel').val().trim();
      if (num||tel) {
        account.contact = {};
        if (num) account.contact.number = num;
        if (tel) account.contact.tel = tel;
      }
      const dept = $('#updateDepartment').val().trim(); if (dept) account.department = dept;
      const pos  = $('#updatePosition').val().trim();   if (pos) account.position   = pos;
      const roles= $('#updateRole').val().trim();
      if (roles) account.role = roles.split(',').map(r=>r.trim()).filter(r=>r);

      const requestBody = { account };
      const env = $('#envSelection').val();
      let baseUrl;
      if (env==='custom') {
        const b = $('#customEnvUrl').val().trim().replace(/\/$/, '');
        if (!b) return alert('사용자 지정 Base URL을 입력하세요.');
        baseUrl = `${b}/v2.0/api/members`;
      } else {
        baseUrl = memberUrlMap[env];
      }
      const url = `${baseUrl}/${encodeURIComponent(memberId)}`;

      $('#updateResult').html(`실행 URL: ${url}\n수정 중...`);
      fetch(url, {
        method: 'PATCH',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': 'Bearer '+token
        },
        body: JSON.stringify(requestBody)
      })
      .then(res => {
        if (!res.ok) return res.text().then(t=>{throw new Error(`${res.status}: ${t}`)});
        return res.json();
      })
      .then(data => {
        $('#updateResult').html('수정 성공.\n'+JSON.stringify(data,null,2));
      })
      .catch(err => {
        $('#updateResult').html('Error: '+err);
      });
    }

    // === 구성원 목록 조회 ===
    function listMembers(viewType) {
      const token = $('#accessToken').val().trim();
      if (!token) return alert('먼저 Access Token 발급해주세요.');

      const env = $('#envSelection').val();
      let baseUrl;
      if (env==='custom') {
        const b = $('#customEnvUrl').val().trim().replace(/\/$/, '');
        if (!b) return alert('사용자 지정 Base URL을 입력하세요.');
        baseUrl = `${b}/v2.0/api/members`;
      } else {
        baseUrl = memberUrlMap[env];
      }
      const url = baseUrl;

      if (viewType==='json') {
        $('#jsonContainer').show();
        $('#tableContainer').hide();
      } else {
        $('#jsonContainer').hide();
        $('#tableContainer').show();
      }

      $('#listResultJson').text('조회 중...');
      $('#listResultTable tbody').empty();

      fetch(url, {
        method: 'GET',
        headers: { 'Authorization': 'Bearer '+token }
      })
      .then(res => res.json())
      .then(data => {
        $('#listResultJson').text(JSON.stringify(data,null,2));
        if (viewType==='table') {
          data.members.forEach(m => {
            const date = new Date(m.create_date).toLocaleString();
            $('#listResultTable tbody').append(`
              <tr>
                <td>${m.id}</td>
                <td>${m.name}</td>
                <td>${m.department||'-'}</td>
                <td>${m.position||'-'}</td>
                <td>${date}</td>
                <td>${m.enabled}</td>
              </tr>
            `);
          });
        }
      })
      .catch(err => {
        $('#listResultJson').text('조회 실패: '+err);
      });
    }
    // === 그룹 추가 (수동) ===
function addGroup() {
  const token = document.getElementById("accessToken").value.trim();
  if (!token) {
    alert("먼저 Access Token을 발급받아주세요.");
    return;
  }

  // Base URL 결정 (custom 포함)
  let baseUrl;
  const env = document.getElementById("envSelection").value;
  if (env === "custom") {
    const b = document.getElementById("customEnvUrl").value.trim().replace(/\/$/, "");
    if (!b) {
      alert("사용자 지정 Base URL을 입력해주세요.");
      return;
    }
    baseUrl = b + "/v2.0/api/groups";
  } else {
    // SaaS / CSAP 환경
    baseUrl = env === "op_saas"
      ? "https://kr-api.eformsign.com/v2.0/api/groups"
      : "https://www.gov-eformsign.com/Service/v2.0/api/groups";
  }

  // 폼 입력 값 수집
  const name = document.getElementById("groupName").value.trim();
  if (!name) {
    alert("그룹 이름을 입력해주세요.");
    return;
  }
  const description = document.getElementById("groupDescription").value.trim();
  const membersText = document.getElementById("groupMembers").value.trim();
  const members = membersText
    ? membersText.split(",").map(s => s.trim()).filter(s => s)
    : [];

  const body = {
    group: {
      name: name,
      description: description,
      members: members
    }
  };

  // 호출 및 결과 표시
  document.getElementById("groupResult").innerText = "그룹 추가 중...";
  fetch(baseUrl, {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      "Authorization": "Bearer " + token
    },
    body: JSON.stringify(body)
  })
  .then(res => {
    if (!res.ok) {
      // 에러 메시지도 최대한 살려서
      return res.text().then(txt => {
        throw new Error(txt || `HTTP ${res.status}`);
      });
    }
    return res.json();    // 여기서 실제 JSON 파싱
  })
  .then(json => {
    const out = {
      message: "그룹 추가 성공",
      response: json    // 이제 실제 response body
    };
    $('#groupResult').text(JSON.stringify(out, null, 2));
  })
  .catch(err => {
    const out = {
      message: "그룹 추가 실패",
      error: err.toString()
    };
    $('#groupResult').text(JSON.stringify(out, null, 2));
  });
}

    // === 엑셀 템플릿 다운로드 ===
    function downloadTemplate() {
      var wb = XLSX.utils.book_new();
      var ws_data = [
        ["id","password","first_name","contact_tel","contact_number","contact_country_number","department","position","agreement_marketing","role","external_uuid","external_account_id"],
        ["example@forcs.com","1111","Example","01012345678","01087654321","+82","연구소","연구원","true","company_manager,template_manager","123456","example@sso.com"]
      ];
      var ws = XLSX.utils.aoa_to_sheet(ws_data);
      XLSX.utils.book_append_sheet(wb, ws, "Template");
      var wbout = XLSX.write(wb, { bookType:'xlsx', type:'binary' });
      function s2ab(s){ var buf=new ArrayBuffer(s.length), view=new Uint8Array(buf); for(var i=0;i<s.length;i++) view[i]=s.charCodeAt(i)&0xFF; return buf; }
      var blob = new Blob([s2ab(wbout)], { type:"application/octet-stream" });
      var url = URL.createObjectURL(blob);
      var a = document.createElement("a"); a.href = url; a.download = "멤버추가_템플릿.xlsx"; document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url);
    }

    function downloadDeleteTemplate() {
      var wb = XLSX.utils.book_new();
      var ws_data = [["id"],["example@forcs.com"]];
      var ws = XLSX.utils.aoa_to_sheet(ws_data);
      XLSX.utils.book_append_sheet(wb, ws, "DeleteTemplate");
      var wbout = XLSX.write(wb, { bookType:'xlsx', type:'binary' });
      function s2ab(s){ var buf=new ArrayBuffer(s.length), view=new Uint8Array(buf); for(var i=0;i<s.length;i++) view[i]=s.charCodeAt(i)&0xFF; return buf; }
      var blob = new Blob([s2ab(wbout)], { type:"application/octet-stream" });
      var url = URL.createObjectURL(blob);
      var a = document.createElement("a"); a.href = url; a.download = "멤버삭제_템플릿.xlsx"; document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url);
    }

    function downloadUpdateTemplate() {
      var wb = XLSX.utils.book_new();
      var ws_data = [
        ["id","name","enabled","contact_number","contact_tel","department","position","role"],
        ["example@forcs.com","홍길동","true","01023456789","01012345678","연구소","연구원","company_manager,template_manager"]
      ];
      var ws = XLSX.utils.aoa_to_sheet(ws_data);
      XLSX.utils.book_append_sheet(wb, ws, "UpdateTemplate");
      var wbout = XLSX.write(wb, { bookType:'xlsx', type:'binary' });
      function s2ab(s){ var buf=new ArrayBuffer(s.length), view=new Uint8Array(buf); for(var i=0;i<s.length;i++) view[i]=s.charCodeAt(i)&0xFF; return buf; }
      var blob = new Blob([s2ab(wbout)], { type:"application/octet-stream" });
      var url = URL.createObjectURL(blob);
      var a = document.createElement("a"); a.href = url; a.download = "멤버수정_템플릿.xlsx"; document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url);
    }

    // === 엑셀 파일 검증 / 실행 ===
    // (추가)
    function validateExcelFile() {
      const fileInput = document.getElementById("excelFileInput");
      if (!fileInput.files || fileInput.files.length===0) {
        alert("엑셀 파일을 선택해주세요.");
        return;
      }
      const reader = new FileReader();
      reader.onload = e => {
        let workbook;
        try { workbook = XLSX.read(e.target.result, { type:'binary' }); }
        catch(err) { alert("파싱 오류: "+err); return; }
        const sheet = workbook.Sheets[workbook.SheetNames[0]];
        const rows = XLSX.utils.sheet_to_json(sheet);
        if (rows.length===0) { alert("데이터 없음"); return; }
        validExcelRows = []; invalidExcelRows=[];
        rows.forEach((row,i)=>{
          const id = row['id']||row['account_id']||"";
          const pw = row['password']||"";
          const fn = row['first_name']||"";
          if (id&&pw&&fn) validExcelRows.push(row);
          else invalidExcelRows.push({ rowNumber:i+2, row });
        });
        let summary = `검증 완료\n총:${rows.length} 유효:${validExcelRows.length} 오류:${invalidExcelRows.length}\n`;
        if (invalidExcelRows.length) {
          summary+="오류행:\n";
          invalidExcelRows.forEach(x=> {
            let missing=[];
            if (!x.row['id']&&!x.row['account_id']) missing.push("id");
            if (!x.row['password']) missing.push("password");
            if (!x.row['first_name']) missing.push("first_name");
            summary+=`행 ${x.rowNumber}: ${missing.join(",")}\n`;
          });
        }
        document.getElementById("excelResult").innerText = summary;
        document.getElementById("excelExecuteSection").style.display = validExcelRows.length>0?"block":"none";
      };
      reader.onerror = err => alert("읽기 오류: "+err);
      reader.readAsBinaryString(fileInput.files[0]);
    }

    function executeExcelMemberAddition() {
      const token = $('#accessToken').val().trim();
      if (!token) { alert("먼저 Access Token 발급해주세요."); return; }
      const env = $('#envSelection').val();
      let baseUrl = env==='custom'
        ? `${$('#customEnvUrl').val().trim().replace(/\/$/,'')}/v2.0/api/members`
        : memberUrlMap[env];
      if ($('input[name="mailOption"]:checked').val()==='false') baseUrl += '?mailOption=false';
      Promise.all(validExcelRows.map(row=>{
        let account = {
          id: row['id']||row['account_id']||"",
          password: row['password']||"",
          first_name: row['first_name']||""
        };
        if (row['contact_tel']) account.contact = { tel: row['contact_tel'] };
        if (row['contact_number']) account.contact = Object.assign(account.contact||{},{ number: row['contact_number'] });
        if (row['contact_country_number']) account.contact = Object.assign(account.contact||{},{ country_number: row['contact_country_number'] });
        if (row['department']) account.department = row['department'];
        if (row['position']) account.position = row['position'];
        if (row['agreement_marketing']==="true"||row['agreement_marketing']===true) account.agreement={ marketing:true };
        if (row['role']) account.role=row['role'].split(",").map(s=>s.trim());
        if (row['external_uuid']) account.external_sso_info = Object.assign(account.external_sso_info||{},{ uuid:row['external_uuid'] });
        if (row['external_account_id']) account.external_sso_info = Object.assign(account.external_sso_info||{},{ account_id:row['external_account_id'] });

        return fetch(baseUrl,{
          method:'POST',
          headers:{ 'Content-Type':'application/json','Authorization':'Bearer '+token },
          body:JSON.stringify({ account })
        })
        .then(res=>{
          if (!res.ok) return res.text().then(t=>({ error:`${res.status}`, response:t, row }));
          return res.json().then(data=>({ success:true, data, row }));
        })
        .catch(err=>({ error:err.toString(), row }));
      }))
      .then(results=>{
        const successCount = results.filter(r=>r.success).length;
        const errorCount = results.length-successCount;
        let summary = `엑셀 처리 완료 (추가) 성공:${successCount} 실패:${errorCount}\n\n`;
        summary += JSON.stringify(results,null,2);
        document.getElementById("excelResult").innerText = summary;
      });
    }

    function validateExcelFileForDeletion() {
      const fileInput = document.getElementById("excelFileDeleteInput");
      if (!fileInput.files||!fileInput.files.length) { alert("파일 선택"); return; }
      const reader = new FileReader();
      reader.onload = e => {
        let wb;
        try { wb=XLSX.read(e.target.result,{type:'binary'}); }
        catch(err){ alert("파싱 오류:"+err); return; }
        const sheet=wb.Sheets[wb.SheetNames[0]];
        const rows=XLSX.utils.sheet_to_json(sheet);
        validDeleteRows=[]; invalidDeleteRows=[];
        rows.forEach((row,i)=>{
          const id=row['id']||row['account_id']||"";
          if (id) validDeleteRows.push(row);
          else invalidDeleteRows.push({ rowNumber:i+2 });
        });
        let s=`검증 완료 삭제\n총:${rows.length} 유효:${validDeleteRows.length} 오류:${invalidDeleteRows.length}\n`;
        if (invalidDeleteRows.length) {
          s+="오류 행 번호:\n"+invalidDeleteRows.map(x=>`행 ${x.rowNumber}`).join("\n");
        }
        document.getElementById("excelDeleteResult").innerText = s;
        document.getElementById("excelDeleteExecuteSection").style.display = validDeleteRows.length>0?"block":"none";
      };
      reader.onerror=err=>alert("읽기 오류:"+err);
      reader.readAsBinaryString(fileInput.files[0]);
    }

    function executeExcelMemberDeletion() {
      const token = $('#accessToken').val().trim();
      if (!token) { alert("먼저 Access Token 발급해주세요."); return; }
      const env = $('#envSelection').val();
      const baseUrl = env==='custom'
        ? `${$('#customEnvUrl').val().trim().replace(/\/$/,'')}/v2.0/api/members`
        : memberUrlMap[env];
      const mailOpt = $('input[name="mailOptionDeleteExcel"]:checked').val();
      Promise.all(validDeleteRows.map(row=>{
        let url = `${baseUrl}/${encodeURIComponent(row['id']||row['account_id'])}`;
        if (mailOpt==='false') url += '?mailOption=false';
        return fetch(url,{
          method:'DELETE',
          headers:{ 'accept':'*/*','Content-Type':'application/json','Authorization':'Bearer '+token },
          body:JSON.stringify({})
        })
        .then(res=>{
          if (!res.ok) return res.text().then(t=>({ error:`${res.status}`, response:t, row }));
          return res.text().then(t=>t?JSON.parse(t):{}).then(data=>({ success:true, data, row }));
        })
        .catch(err=>({ error:err.toString(), row }));
      }))
      .then(results=>{
        const successCount = results.filter(r=>r.success).length;
        const errorCount = results.length-successCount;
        let summary = `엑셀 처리 완료 (삭제) 성공:${successCount} 실패:${errorCount}\n\n` + JSON.stringify(results,null,2);
        document.getElementById("excelDeleteResult").innerText = summary;
      });
    }

    function validateExcelFileForUpdate() {
      const fileInput = document.getElementById("excelFileUpdateInput");
      if (!fileInput.files||!fileInput.files.length){ alert("파일 선택"); return; }
      const reader = new FileReader();
      reader.onload = e => {
        let wb;
        try { wb=XLSX.read(e.target.result,{type:'binary'}); }
        catch(err){ alert("파싱 오류:"+err); return; }
        const sheet=wb.Sheets[wb.SheetNames[0]];
        const rows=XLSX.utils.sheet_to_json(sheet);
        validUpdateRows=[]; invalidUpdateRows=[];
        rows.forEach((row,i)=>{
          const id=row['id']||"";
          const hasField = row['name']||row['enabled']||row['contact_number']||row['contact_tel']||row['department']||row['position']||row['role'];
          if (id && hasField) validUpdateRows.push(row);
          else invalidUpdateRows.push({ rowNumber:i+2 });
        });
        let s=`검증 완료 수정\n총:${rows.length} 유효:${validUpdateRows.length} 오류:${invalidUpdateRows.length}\n`;
        if (invalidUpdateRows.length) {
          s+="오류 행 번호:\n"+invalidUpdateRows.map(x=>`행 ${x.rowNumber}`).join("\n");
        }
        document.getElementById("excelUpdateResult").innerText = s;
        document.getElementById("excelUpdateExecuteSection").style.display = validUpdateRows.length>0?"block":"none";
      };
      reader.onerror=err=>alert("읽기 오류:"+err);
      reader.readAsBinaryString(fileInput.files[0]);
    }

    function executeExcelMemberUpdate() {
      const token = $('#accessToken').val().trim();
      if (!token) { alert("먼저 Access Token 발급해주세요."); return; }
      const env = $('#envSelection').val();
      const baseUrl = env==='custom'
        ? `${$('#customEnvUrl').val().trim().replace(/\/$/,'')}/v2.0/api/members`
        : memberUrlMap[env];
      Promise.all(validUpdateRows.map(row=>{
        let id = row['id']||"";
        let updateObj = { id };
        if (row['name']) updateObj.name = row['name'];
        if (row['enabled']) updateObj.enabled = (row['enabled'].toString().toLowerCase()==='true');
        if (row['contact_number']) updateObj.contact = Object.assign(updateObj.contact||{},{ number:row['contact_number'] });
        if (row['contact_tel'])    updateObj.contact = Object.assign(updateObj.contact||{},{ tel:row['contact_tel'] });
        if (row['department'])     updateObj.department = row['department'];
        if (row['position'])       updateObj.position   = row['position'];
        if (row['role'])           updateObj.role = row['role'].split(',').map(s=>s.trim());

        const requestBody = { account:updateObj };
        const url = `${baseUrl}/${encodeURIComponent(id)}`;

        return fetch(url,{
          method:'PATCH',
          headers:{ 'Content-Type':'application/json','Authorization':'Bearer '+token },
          body:JSON.stringify(requestBody)
        })
        .then(res=>{
          if (!res.ok) return res.text().then(t=>({ error:`${res.status}`, response:t, row }));
          return res.json().then(data=>({ success:true, data, row }));
        })
        .catch(err=>({ error:err.toString(), row }));
      }))
      .then(results=>{
        const successCount = results.filter(r=>r.success).length;
        const errorCount = results.length-successCount;
        let summary = `엑셀 처리 완료 (수정) 성공:${successCount} 실패:${errorCount}\n\n` + JSON.stringify(results,null,2);
        document.getElementById("excelUpdateResult").innerText = summary;
      });
    }
     function downloadGroupTemplate() {
      // 엑셀 템플릿 생성 (name, description, members)
      var wb = XLSX.utils.book_new();
      var wsData = [
        ["name","description","members"],
        ["테스트그룹","클라우드팀","test1@forcs.com,test2@forcs.com"]
      ];
      var ws = XLSX.utils.aoa_to_sheet(wsData);
      XLSX.utils.book_append_sheet(wb, ws, "GroupTemplate");
      var wbout = XLSX.write(wb, { bookType:'xlsx', type:'binary' });
      function s2ab(s) {
        var buf = new ArrayBuffer(s.length), view = new Uint8Array(buf);
        for (var i = 0; i < s.length; i++) view[i] = s.charCodeAt(i)&0xFF;
        return buf;
      }
      var blob = new Blob([s2ab(wbout)], { type:"application/octet-stream" });
      var url = URL.createObjectURL(blob);
      var a = document.createElement("a");
      a.href = url; a.download = "group_template.xlsx";
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    var validGroupRows = [], invalidGroupRows = [];
    function validateExcelGroupFile() {
      var fileInput = document.getElementById("excelGroupFileInput");
      if (!fileInput.files || !fileInput.files.length) {
        alert("엑셀 파일을 선택해주세요.");
        return;
      }
      var reader = new FileReader();
      reader.onload = function(e) {
        var wb = XLSX.read(e.target.result, { type:'binary' });
        var rows = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
        validGroupRows = []; invalidGroupRows = [];
        rows.forEach(function(row, idx) {
          if (row.name && row.members) {
            validGroupRows.push(row);
          } else {
            invalidGroupRows.push(idx+2);
          }
        });
        var msg = "검증 완료\n총 행: " + rows.length +
                  "\n유효 행: " + validGroupRows.length +
                  "\n오류 행: " + invalidGroupRows.length;
        if (invalidGroupRows.length) {
          msg += "\n오류 행 번호: " + invalidGroupRows.join(", ");
        }
        document.getElementById("excelGroupResult").innerText = msg;
        document.getElementById("excelGroupExecuteSection").style.display = validGroupRows.length ? "block" : "none";
      };
      reader.readAsBinaryString(fileInput.files[0]);
    }

    function executeExcelGroupAddition() {
  const token = document.getElementById("accessToken").value.trim();
  if (!token) return alert("먼저 Access Token을 발급받아주세요.");

  // ① Base URL 결정 (custom 포함)
  let baseUrl;
  const env = document.getElementById("envSelection").value;
  if (env === "custom") {
    const b = document.getElementById("customEnvUrl").value.trim().replace(/\/$/, "");
    if (!b) return alert("사용자 지정 Base URL을 입력해주세요.");
    baseUrl = b + "/v2.0/api/groups";
  } else {
    baseUrl = env === "op_saas"
      ? "https://kr-api.eformsign.com/v2.0/api/groups"
      : "https://www.gov-eformsign.com/Service/v2.0/api/groups";
  }

  // ② 모든 행에 대해 fetch → JSON 파싱 → 성공/실패 객체 생성
  const promises = validGroupRows.map(row => {
    const membersArray = row.members.split(",").map(s => s.trim());
    const body = { group: { name: row.name, description: row.description || "", members: membersArray } };

    return fetch(baseUrl, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "Authorization": "Bearer " + token
      },
      body: JSON.stringify(body)
    })
    .then(res => {
      if (!res.ok) {
        // 실패 시 서버가 남긴 메시지를 텍스트로 읽어서 에러로 던져줍니다
        return res.text().then(txt => { throw new Error(txt || `HTTP ${res.status}`) });
      }
      // 성공 시 JSON body 로 파싱
      return res.json();
    })
    .then(json => {
      return { success: true, row: row, response: json };
    })
    .catch(err => {
      return { success: false, row: row, error: err.toString() };
    });
  });

  // ③ 모든 요청이 끝나면 결과 요약 + 디테일 출력
  Promise.all(promises).then(results => {
    const successCount = results.filter(r => r.success).length;
    const errorCount   = results.length - successCount;
    const out = {
      summary: `엑셀 그룹 추가 완료 (성공 ${successCount}건, 실패 ${errorCount}건)`,
      details: results
    };
    // <pre> 태그 안에 들여쓰기 있는 JSON 으로 출력
    $('#excelGroupResult').text(JSON.stringify(out, null, 2));
  });
}

  </script>
</body>

</html>
