<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>eformsign 문서 API 테스터</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body { font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif; background-color: #f4f4f4; margin: 0; padding: 20px; }
        .container { max-width: 900px; margin: 30px auto; background: #fff; border: 1px solid #ddd; border-radius: 4px; padding: 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        h1, h2, h3 { margin-top: 0; }
        h2 { border-bottom: 1px solid #ddd; padding-bottom: 8px; }
        .form-group { margin-bottom: 15px; }
        label { display: block; font-weight: bold; margin-bottom: 5px; }
        input, select, button, textarea { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
        button { cursor: pointer; background-color: #007bff; color: white; border: none; transition: background-color 0.2s; }
        button:hover { background-color: #0056b3; }
        .radio-group { display: flex; flex-wrap: wrap; gap: 10px 20px; align-items: center; }
        .radio-group label { font-weight: normal; margin: 0; }
        .section { margin-bottom: 30px; }
        #tokenResult, .result-box { margin-top: 15px; background: #f7f7f7; padding: 10px; border: 1px solid #ddd; white-space: pre-wrap; word-break: break-all; font-size: 0.9em; max-height: 400px; overflow-y: auto; }
        .result-box pre { white-space: pre-wrap; word-break: break-all; margin: 0; }
        .url-display { font-size: 0.8em; color: #666; margin-bottom: 10px; word-break: break-all; }
        .url-display #dynamicDocId { color: #007bff; font-weight: bold; }

        /* --- 개선 사항 2: 버튼 UI 스타일 --- */
        .checkbox-group { display: flex; flex-wrap: wrap; gap: 10px; }
        .checkbox-group label {
            display: inline-block;
            padding: 8px 12px;
            background-color: #e9ecef;
            border: 1px solid #ced4da;
            border-radius: 4px;
            font-weight: normal;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            user-select: none; /* 텍스트 선택 방지 */
        }
        .checkbox-group input[type="checkbox"] {
            display: none; /* 원래 체크박스는 숨김 */
        }
        .checkbox-group label.selected {
            background-color: #007bff;
            color: white;
            border-color: #007bff;
        }
        /* ---------------------------------- */
    </style>
</head>
<body>
    <div class="container">
        <h1>eformsign 문서 API 테스터</h1>
        
        <div class="section" id="tokenSection">
            <h2>Access Token 발급</h2>
            <div class="form-group">
                <label for="envSelection">환경 선택:</label>
                <select id="envSelection">
                    <option value="op_saas">운영 (SaaS)</option>
                    <option value="csap">공공 (CSAP)</option>
                </select>
            </div>
            <div class="url-display" id="tokenUrlDisplay"></div>
            <div class="form-group">
                <label for="apiKey">API-KEY:</label>
                <input type="text" id="apiKey" placeholder="API-KEY 입력">
            </div>
            <div class="form-group">
                <label>비밀 키 입력 방식:</label>
                <div class="radio-group">
                    <label><input type="radio" name="secretKeyMethod" value="signature" checked> Signature 방식</label>
                    <label><input type="radio" name="secretKeyMethod" value="bearer"> Bearer token 방식</label>
                </div>
            </div>
            <div class="form-group">
                <label id="secretKeyLabel" for="privateKeyHex">비밀 키 (Secret key, Hex):</label>
                <input type="text" id="privateKeyHex" placeholder="예: 30... (Signature 방식)">
            </div>
            <div class="form-group">
                <label for="user_id_token">User ID:</label>
                <input type="text" id="user_id_token" placeholder="User ID 입력">
            </div>
            <button onclick="getAccessToken()">Access Token 발급</button>
            <div class="form-group">
                <label for="accessToken">Access Token:</label>
                <textarea id="accessToken" rows="3" readonly></textarea>
            </div>
            <div id="tokenResult"></div>
        </div>

        <div class="section" id="documentInfoSection">
            <h2>문서 정보 조회 (GET /documents/{DOCUMENT_ID})</h2>
            <p>Access Token은 위에서 발급받은 값을 사용합니다.</p>
            <div class="url-display" id="docInfoUrlDisplay">
                API URL: <span id="baseUrlSpan"></span><span id="dynamicDocId">{DOCUMENT_ID}</span>
            </div>
            
            <div class="form-group">
                <label for="documentId">DOCUMENT_ID (필수):</label>
                <input type="text" id="documentId" placeholder="조회할 문서의 ID를 입력하세요">
            </div>

            <div class="form-group">
                <label>Query String 옵션(클릭 시 파란색으로 하이라이팅 되며 해당 옵션이 true값으로 변화합니다.):</label>
                <div class="checkbox-group">
                    <label><input type="checkbox" name="docInfoQs" value="include_fields"><span>필드 포함</span></label>
                    <label><input type="checkbox" name="docInfoQs" value="include_histories"><span>문서 이력 포함</span></label>
                    <label><input type="checkbox" name="docInfoQs" value="include_previous_status"><span>이전 단계 정보 포함</span></label>
                    <label><input type="checkbox" name="docInfoQs" value="include_next_status"><span>다음 단계 정보 포함</span></label>
                    <label><input type="checkbox" name="docInfoQs" value="include_external_token"><span>사용자 Token 포함</span></label>
                    <label><input type="checkbox" name="docInfoQs" value="include_detail_template_info"><span>상세 템플릿 정보 포함</span></label>
                </div>
            </div>
            <button onclick="getDocumentInfo()">문서 정보 조회</button>
            <div class="result-box" id="docInfoResult"></div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jsrsasign/10.5.25/jsrsasign-all-min.js"></script>
    <script>
        const DOMAINS = {
            op_saas: 'https://kr-api.eformsign.com',
            csap: 'https://www.gov-eformsign.com/Service'
        };

        function updateUrlDisplay() {
            const env = $('#envSelection').val();
            const domain = DOMAINS[env];
            $('#tokenUrlDisplay').text(`Access Token URL: ${domain}/v2.0/api_auth/access_token`);
            // 개선 사항 1: URL 표시 부분 분리
            $('#baseUrlSpan').text(`${domain}/v2.0/api/documents/`);
        }

        $(document).ready(function() {
            updateUrlDisplay();
            $('#envSelection').change(updateUrlDisplay);

            $('input[name="secretKeyMethod"]').change(() => {
                const m = $('input[name="secretKeyMethod"]:checked').val();
                $('#secretKeyLabel').text(m === 'signature' ? '비밀 키 (Secret key, Hex):' : '비밀 토큰:');
                $('#privateKeyHex').attr('placeholder', m === 'signature' ? '예: 30... (Signature 방식)' : '예: test (Bearer token 방식)');
            });
            
            // --- 개선 사항 1: DOCUMENT_ID 입력 시 URL 동적 업데이트 ---
            $('#documentId').on('keyup input', function() {
                const docId = $(this).val().trim();
                if (docId) {
                    $('#dynamicDocId').text(docId);
                } else {
                    $('#dynamicDocId').text('{DOCUMENT_ID}');
                }
            });

            // --- 개선 사항 2: 버튼 UI 초기화 및 이벤트 핸들링 ---
            // 페이지 로드 시 초기 상태 설정
            $('.checkbox-group input[type="checkbox"]').each(function() {
                $(this).closest('label').toggleClass('selected', this.checked);
            });

            // 체크박스 상태 변경 시 스타일 업데이트
            $('.checkbox-group input[type="checkbox"]').on('change', function() {
                $(this).closest('label').toggleClass('selected', this.checked);
            });
        });

        function getAccessToken() {
            const execTime = Date.now();
            const apiKey = $('#apiKey').val().trim();
            const privateKey = $('#privateKeyHex').val().trim();
            const memberId = $('#user_id_token').val().trim();
            if (!apiKey || !privateKey || !memberId) {
                alert('Access Token 발급에 필요한 모든 값을 입력해주세요.');
                return;
            }

            let signature;
            if ($('input[name="secretKeyMethod"]:checked').val() === 'signature') {
                try {
                    const keyObj = KEYUTIL.getKeyFromPlainPrivatePKCS8Hex(privateKey);
                    const sig = new KJUR.crypto.Signature({ alg: 'SHA256withECDSA' });
                    sig.init(keyObj);
                    sig.updateString(execTime.toString());
                    signature = sig.sign();
                } catch (e) {
                    alert('서명 생성 오류: ' + e);
                    return;
                }
            } else {
                signature = 'Bearer ' + privateKey;
            }

            const url = `${DOMAINS[$('#envSelection').val()]}/v2.0/api_auth/access_token`;
            $('#tokenResult').html('<pre>토큰 발송 중...</pre>');

            $.ajax({
                url, method: 'POST', contentType: 'application/json; charset=UTF-8',
                headers: { 'Authorization': 'Bearer ' + btoa(apiKey), 'eformsign_signature': signature },
                data: JSON.stringify({ execution_time: execTime, member_id: memberId }),
                success(data) {
                    $('#accessToken').val(data.oauth_token.access_token);
                    $('#tokenResult').html('<pre>' + JSON.stringify(data, null, 2) + '</pre>');
                },
                error(xhr) {
                    let msg;
                    try { msg = JSON.parse(xhr.responseText); } 
                    catch { msg = { error: xhr.statusText }; }
                    $('#tokenResult').html(`<pre>에러(${xhr.status}): ${JSON.stringify(msg, null, 2)}</pre>`);
                }
            });
        }

        async function getDocumentInfo() {
            const token = $('#accessToken').val().trim();
            const documentId = $('#documentId').val().trim();
            if (!token) {
                alert('Access Token을 먼저 발급받아주세요.'); return;
            }
            if (!documentId) {
                alert('DOCUMENT_ID를 입력해주세요.'); return;
            }

            const domain = DOMAINS[$('#envSelection').val()];
            
            const params = new URLSearchParams();
            $('input[name="docInfoQs"]:checked').each(function() {
                params.append($(this).val(), 'true');
            });
            const queryString = params.toString();

            let url = `${domain}/v2.0/api/documents/${documentId}`;
            if (queryString) {
                url += `?${queryString}`;
            }

            $('#docInfoResult').html(`<p>실행 URL: ${url}</p><p id="statusMessage">조회 중...</p>`);

            try {
                const response = await fetch(url, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    }
                });

                const resultText = await response.text();
                const resultJson = JSON.parse(resultText);

                if (!response.ok) {
                    throw new Error(`네트워크 응답 문제 ${response.status}: ${resultText}`);
                }

                $('#statusMessage').text('조회 완료');
                $('#docInfoResult').append(`<pre>${JSON.stringify(resultJson, null, 2)}</pre>`);

            } catch (err) {
                $('#statusMessage').text('조회 실패');
                let errorContent = err.message;
                try {
                    const errorJson = JSON.parse(errorContent.substring(errorContent.indexOf('{')));
                    errorContent = `네트워크 응답 문제 ${err.message.split(':')[0]}:\n${JSON.stringify(errorJson, null, 2)}`;
                } catch {}
                $('#docInfoResult').append(`<pre>Error: ${errorContent}</pre>`);
            }
        }
    </script>
</body>
</html>