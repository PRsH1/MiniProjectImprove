<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>템플릿으로 문서 작성, 수정, 미리보기</title>

  <script src="https://www.eformsign.com/plugins/jquery/jquery.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jsrsasign/8.0.20/jsrsasign-all-min.js"></script>
  <script src="https://www.eformsign.com/lib/js/efs_embedded_v2.js"></script>

  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #eef2f7;
      color: #333;
      margin: 0;
      padding: 20px;
      display: flex;
      height: 100vh;
      box-sizing: border-box;
    }

    h2 {
      text-align: center;
      color: #333;
      margin-bottom: 20px;
      font-size: 1.5em;
    }

    .left-panel,
    .right-panel {
      padding: 20px;
      background: #ffffff;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      box-sizing: border-box;
    }

    .left-panel {
      width: 45%;
      overflow-y: auto;
      margin-right: 5%;
    }

    .right-panel {
      width: 50%;
      display: flex;
      flex-direction: column;
    }

    .form-group {
      margin-bottom: 15px;
      display: flex;
      flex-direction: column;
      width: 100%;
    }

    .form-group label {
      font-weight: bold;
      margin-bottom: 5px;
      color: #555;
    }

    .form-group input,
    .form-group select {
      width: 100%;
      padding: 10px;
      font-size: 14px;
      border: 1px solid #ccc;
      border-radius: 4px;
      transition: border-color 0.3s;
      box-sizing: border-box;
    }

    .form-group input:focus,
    .form-group select:focus {
      outline: none;
      border-color: #007bff;
    }

    .btn {
      width: 100%;
      padding: 12px;
      font-size: 16px;
      font-weight: bold;
      color: #ffffff;
      background-color: #007bff;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      transition: background-color 0.3s ease;
      margin-top: 10px;
    }

    .btn:hover {
      background-color: #0056b3;
    }

    #buttonList {
  display: none;           /* 토글 스위치로 제어 */
  flex-direction: row;     /* 좌→우 방향 */
  flex-wrap: wrap;         /* 공간이 부족하면 다음 줄로 wrap */
  gap: 10px;               /* 버튼 사이 간격 */
  justify-content: center; /* 가운데 정렬 */
}
    #buttonList button {
      width: 100px;
      height: 35px;
      border-radius: 4px;
      background-color: #6c757d;
      color: #ffffff;
      border: none;
      cursor: pointer;
      font-size: 14px;
      display: none;
      transition: background-color 0.3s;
    }

    #buttonList button:hover {
      background-color: #5a6268;
    }

    .iframe-title {
      text-align: center;
      font-weight: bold;
      color: #444;
      margin-bottom: 10px;
    }

    .iframe-container {
      flex: 1;
      border: 2px solid #ddd;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    iframe {
      width: 100%;
      height: 100%;
      border: none;
    }

    /* Responsive */
    @media only screen and (max-width: 768px) {
      .left-panel,
      .right-panel {
        width: 100%;
        margin: 0;
      }
    }

    @media only screen and (max-width: 600px) {
      .btn,
      #buttonList button {
        font-size: 14px;
        padding: 10px;
      }
    }

    /* 토글 스위치 스타일 */
    .switch {
      position: relative;
      display: inline-block;
      width: 50px;
      height: 24px;
      vertical-align: middle;
    }

    .switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }

    .slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: #ccc;
      transition: 0.4s;
      border-radius: 24px;
    }

    .slider:before {
      position: absolute;
      content: "";
      height: 18px;
      width: 18px;
      left: 3px;
      bottom: 3px;
      background-color: white;
      transition: 0.4s;
      border-radius: 50%;
    }

    input:checked+ .slider {
      background-color: #007bff;
    }

    input:checked+ .slider:before {
      transform: translateX(26px);
    }
  </style>

  <script type="text/javascript">
    var rs = KJUR;
    var execution_time = Date.now() + "";
    console.log("Execution Time:", execution_time);
    var eformsign, apiKey;

  
    $(document).ready(function () {
      eformsign = new EformSignDocument();

      // URL 업데이트
      $('#serverType').change(updateServerUrl);
      $('#customServerUrl').on('input', updateServerUrl);
      updateServerUrl();

      // 토큰 방식 select → 라벨/플레이스홀더 변경
      $('#tokenMethodSelect').on('change', function () {
        var method = $(this).val();
        if (method === 'signature') {
          $('#secretKeyLabel').text('Private Key Hex:');
          $('#privateKeyHex').attr('placeholder', '비밀키 입력');
        } else {
          $('#secretKeyLabel').text('Bearer Token:');
          $('#privateKeyHex').attr('placeholder', 'Bearer 토큰 입력');
        }
      });

      // 액션 버튼 토글 스위치
      $('#toggleActionSwitch').on('change', function () {
  if (this.checked) {
    // container 만 flex 로 보여주기
    $('#buttonList').css('display', 'flex');
    $('#toggleActionLabel').text('Action 버튼 숨기기');
  } else {
    $('#buttonList').css('display', 'none');
    $('#toggleActionLabel').text('Action 버튼 보이기');
  }
});
// 초기 상태: 숨김
$('#toggleActionSwitch').prop('checked', false).trigger('change');

      // 토큰 발급
      $('#getTokenButton').click(getAccessToken);

      // 문서 시작
      $('#startButton').click(function () {
        if (!$('#accessToken').val() || !$('#refreshToken').val()) {
          alert("먼저 Access Token을 발급하세요.");
          return;
        }
        startDocument();
      });
    });

    function getAccessToken() {
      var method = $('#tokenMethodSelect').val();
      execution_time = Date.now() + "";
      console.log("Updated Execution Time:", execution_time);

      apiKey = $('#apiKey').val();
      var user_id = $('#user_id').val();
      var serverType = $('#serverType').val();
      var requestURL = getApiUrl(serverType);

      var requestBody = {
        execution_time: execution_time,
        member_id: user_id
      };

      var signatureValue;
      if (method === 'signature') {
        var privateKeyHex = $('#privateKeyHex').val();
        var privateKey = KEYUTIL.getKeyFromPlainPrivatePKCS8Hex(privateKeyHex);
        var s_sig = new rs.crypto.Signature({ alg: 'SHA256withECDSA' });
        s_sig.init(privateKey);
        s_sig.updateString(execution_time);
        signatureValue = s_sig.sign();
      } else {
        var bearerInput = $('#privateKeyHex').val();
        signatureValue = 'Bearer ' + bearerInput;
      }

      $.ajax({
        url: requestURL,
        type: 'POST',
        contentType: 'application/json; charset=UTF-8',
        data: JSON.stringify(requestBody),
        beforeSend: function (request) {
          request.setRequestHeader('eformsign_signature', signatureValue);
          request.setRequestHeader('Authorization', 'Bearer ' + btoa(apiKey));
        },
        success: function (data) {
          console.log("Access Token 발급 성공:", data);
          $('#accessToken').val(data.oauth_token.access_token);
          $('#refreshToken').val(data.oauth_token.refresh_token);
          $('#companyId').val(data.api_key.company.company_id);
        },
        error: function (jqXHR) {
          var responseData = JSON.parse(jqXHR.responseText);
          alert('발급 실패:\n코드: ' + responseData.code + '\n메시지: ' + responseData.ErrorMessage);
          console.error("Error Data:", responseData);
        }
      });
    }

    function getApiUrl(serverType) {
      switch (serverType) {
        case 'public':
          return 'https://www.gov-eformsign.com/Service/v2.0/api_auth/access_token';
        case 'custom':
          return $('#customServerUrl').val();
        default:
          return 'https://api.eformsign.com/v2.0/api_auth/access_token';
      }
    }

    function updateServerUrl() {
      var serverType = $('#serverType').val();
      var url = getApiUrl(serverType);
      $('#selectedServerUrl').text(url || 'URL을 입력하세요');
      if (serverType === 'custom') {
        $('#customServerField').show();
      } else {
        $('#customServerField').hide();
      }
    }

    function getDomainUrl(serverType) {
      switch (serverType) {
        case 'test':
          return 'https://test.eformsign.com';
        case 'public':
          return 'https://www.gov-eformsign.com';
        case 'custom':
          return $('#customServerUrl').val();
        default:
          return '';
      }
    }

    function startDocument() {
         
    window.actionTest = function(actionCode) {
      eformsign.sendAction({ type: '01', code: actionCode });
    }

      var serverType = $('#serverType').val();
      var domainUrl = getDomainUrl(serverType);

      var document_option = {
        company: {
          id: $('#companyId').val(),
          country_code: $('#countryCode').val() || "kr",
          user_key: ""
        },
        user: {
          type: "01",
          id: $('#userId').val(),
          refresh_token: $('#refreshToken').val(),
          access_token: $('#accessToken').val()
        },
        mode: {
          type: $('#modeType').val(),
          template_id: $('#templateId').val(),
          document_id: $('#documentId').val()
        },
        layout: {
          context_menu: "true"
        }
      };

      console.log("User Input JSON:", JSON.stringify(document_option, null, 2));

      var success_callback = function (response) {
        $('#eformsign_iframe').attr('src', '');
        alert("문서 작성 성공\n문서 ID: " + response.document_id + "\n문서 제목: " + response.title);
        console.log("Response:", response);
      };

      var error_callback = function (response) {
        alert("문서 생성 실패\n 코드: " + response.code + "\n 메시지:" + response.message);
      };

      var action_callback = function(response) {
  // 1) 우선 모든 버튼을 숨긴다
  $('#buttonList button').hide();

  // 2) 서버에서 받은 액션 배열을 순회하며, 해당 버튼만 show()
  var actions = Array.isArray(response.data) ? response.data : [response.data];
  actions.forEach(function(action) {
    var btn = $('#btn_' + action.code);
    if (btn.length) {
      btn
        .text(action.name)
        .attr('title', action.name)
        .show();
    }
  });
};

      eformsign.document(document_option, "eformsign_iframe",
        success_callback, error_callback, action_callback
      );
      if (domainUrl) eformsign.setDomain(domainUrl);
      eformsign.open();
    }
  </script>
</head>

<body>
  <div class="left-panel">
    <h2>템플릿으로 문서 작성, 수정, 미리보기</h2>

    <div class="form-group">
      <label for="serverType">서버 유형:</label>
      <span id="selectedServerUrl" style="margin-left: 10px; font-style: italic; color: #555;">
        URL을 선택하세요
      </span>
      <select id="serverType">
        <option value="default">기본 서버(SaaS)</option>
        <option value="public">공공 서버</option>
        <option value="custom">사용자 지정 서버</option>
      </select>
    </div>

    <div class="form-group" id="customServerField" style="display: none;">
      <label for="customServerUrl">사용자 지정 서버 URL:</label>
      <input type="text" id="customServerUrl" placeholder="사용자 서버 URL 입력" />
    </div>

    <div class="form-group">
      <label for="tokenMethodSelect">토큰 발급 방식:</label>
      <select id="tokenMethodSelect">
        <option value="signature">Signature 방식</option>
        <option value="bearer">Bearer 방식</option>
      </select>
    </div>

    <div class="form-group">
      <label id="secretKeyLabel" for="privateKeyHex">Private Key Hex:</label>
      <input type="text" id="privateKeyHex" placeholder="비밀키 입력" />
    </div>

    <div class="form-group">
      <label for="apiKey">API Key:</label>
      <input type="text" id="apiKey" placeholder="API Key 입력" />
    </div>

    <div class="form-group">
      <label for="user_id">User ID:</label>
      <input type="text" id="user_id" placeholder="User ID 입력" />
    </div>

    <button type="button" id="getTokenButton" class="btn">Get Access Token</button>

    <div class="form-group">
      <label for="accessToken">Access Token:</label>
      <input type="text" id="accessToken" placeholder="발급된 Access Token" readonly />
    </div>

    <div class="form-group">
      <label for="refreshToken">Refresh Token:</label>
      <input type="text" id="refreshToken" placeholder="발급된 Refresh Token" readonly />
    </div>

    <div class="form-group">
      <label for="companyId">회사 ID:</label>
      <input type="text" id="companyId" placeholder="발급된 회사 ID" readonly />
    </div>

    <div class="form-group">
      <label for="userId">멤버 ID:</label>
      <input type="text" id="userId" placeholder="멤버 ID 입력" />
    </div>

    <div class="form-group">
      <label for="countryCode">Country Code (기본값: kr):</label>
      <input type="text" id="countryCode" placeholder="국가 코드 입력(기본값:kr)" />
    </div>

    <div class="form-group">
      <label for="modeType">Mode Type:</label>
      <input type="text" id="modeType" placeholder="Mode Type 입력 (01: 문서 작성, 02: 문서 처리, 03: 미리 보기)" />
    </div>

    <div class="form-group">
      <label for="templateId">템플릿 ID:</label>
      <input type="text" id="templateId" placeholder="템플릿 ID 입력" />
    </div>

    <div class="form-group">
      <label for="documentId">문서 ID (Mode type 02,03일 경우 필수):</label>
      <input type="text" id="documentId" placeholder="문서 ID 입력" />
    </div>

    <button type="button" id="startButton" class="btn">Start</button>
  </div>

  <div class="right-panel">
    <h2 class="iframe-title">문서 영역</h2>

    <div class="form-group" style="margin-bottom:10px;">
      <label class="switch">
        <input type="checkbox" id="toggleActionSwitch">
        <span class="slider"></span>
      </label>
      <label for="toggleActionSwitch" id="toggleActionLabel" style="margin-left:8px; vertical-align:middle;">
        Action 버튼 보이기
      </label>
    </div>

    <div id="buttonList">
      <button id="btn_01" onclick="actionTest('01');"></button>
      <button id="btn_02" onclick="actionTest('02');"></button>
      <button id="btn_03" onclick="actionTest('03');"></button>
      <button id="btn_04" onclick="actionTest('04');"></button>
      <button id="btn_05" onclick="actionTest('05');"></button>
      <button id="btn_06" onclick="actionTest('06');"></button>
      <button id="btn_07" onclick="actionTest('07');"></button>
      <button id="btn_08" onclick="actionTest('08');"></button>
      <button id="btn_09" onclick="actionTest('09');"></button>
      <button id="btn_10" onclick="actionTest('10');"></button>
      <button id="btn_11" onclick="actionTest('11');"></button>
      <button id="btn_12" onclick="actionTest('12');"></button>
      <button id="btn_13" onclick="actionTest('13');"></button>
      <button id="btn_14" onclick="actionTest('14');"></button>
      <button id="btn_15" onclick="actionTest('15');"></button>
      <button id="btn_16" onclick="actionTest('16');"></button>
      <button id="btn_17" onclick="actionTest('17');"></button>
      <button id="btn_18" onclick="actionTest('18');"></button>
      <button id="btn_19" onclick="actionTest('19');"></button>
      <button id="btn_20" onclick="actionTest('20');"></button>
      <button id="btn_21" onclick="actionTest('21');"></button>
      <button id="btn_22" style="width:150px;" onclick="actionTest('22');"></button>
    </div>

    <div class="iframe-container">
      <iframe id="eformsign_iframe" name="eformsign_iframe"></iframe>
    </div>
  </div>
</body>

</html>
